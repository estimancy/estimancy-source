<h3>
Module d'opération : <%= @operation_model.operation_type.humanize %>
</h3>

<%= form_tag operation.operation_model_save_efforts_path(@operation_model), method: "POST" do %>
  <div class="row-fluid">
    <div class="span12">

      <% effort = PeAttribute.find_by_alias("effort") %>
      <% @elements = Hash.new %>
      <% current_module_project.previous.each do |mp| %>

        <% elem = EstimationValue.where(module_project_id: mp.id,
                                        pe_attribute_id: effort.id,
                                        in_out: "output").first.string_data_probable[current_component.id] %>
        <% if elem.is_a?(Hash) %>
          <% @elements[mp] = elem[mp.wbs_activity.root_element.id][:value] / @operation_model.standard_unit_coefficient %>
        <% else %>
          <% @elements[mp] = elem / @operation_model.standard_unit_coefficient %>
        <% end %>

      <% end %>

      <table class="table">
        <tr>
          <th>
            Module
          </th>
          <th>
            Effort en entrée
          </th>
        </tr>
        <% @elements.each do |mp, val| %>
          <tr>
            <td><%= mp %></td>
            <td>
              <% begin %>
                <%= val.round(2) %>
              <% rescue %>
                <%= val[mp.wbs_activity.root_element.id][:value] %>
              <% end %>
            </td>
          </tr>
        <% end %>
        <tr>
          <td>
            <b>
              Effort total (<%= @operation_model.effort_unit %>)
            </b>
          </td>
          <td>
            <% if @operation_model.operation_type == "addition" %>
              <% res = @elements.values.sum.round(2) %>
            <% elsif @operation_model.operation_type == "moyenne" %>
              <% res = @elements.values.sum / @elements.values.size %>
            <% end %>

            <%= text_field_tag "effort_most_likely", res.round(2), class: "input-small", readonly: (!@operation_model.enabled_input || cannot?(:alter_estimation_plan, @project))  %>
          </td>
        </tr>
      </table>

      <% if can? :execute_estimation_plan, @project %>
        <button type="submit" class="btn btn-default btn-mini pull-right"><%= I18n.t(:save) %></button>
      <% end %>
    </div>
  </div>
<% end %>
