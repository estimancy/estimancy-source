<h3>
  <%= I18n.t(:calculate_duration_and_size) %>
</h3>

<%
   attribute = PeAttribute.find_by_alias("effort")
   effort_week_unit = @staffing_model.effort_week_unit.nil? ? 1 : @staffing_model.effort_week_unit

   ev = EstimationValue.where(:pe_attribute_id => attribute.id,
                              :module_project_id => current_module_project.previous.last,
                              :in_out => "output").first
    begin
      begin
        previous_activity_root = current_module_project.previous.last.wbs_activity.wbs_activity_elements.first.root
        effort = ev.string_data_probable[current_component.id][previous_activity_root.id][:value] / (@staffing_model.standard_unit_coefficient.nil? ? 1 : @staffing_model.standard_unit_coefficient.to_f)
      rescue
        effort = ev.string_data_probable[current_component.id] / (@staffing_model.standard_unit_coefficient.nil? ? 1 : @staffing_model.standard_unit_coefficient.to_f)
      end
    rescue
      begin
        effort = ev.string_data_probable[current_component.id].to_f / (@staffing_model.standard_unit_coefficient.nil? ? 1 : @staffing_model.standard_unit_coefficient.to_f)
      rescue
        effort = 0
      end
    end

    @md_duration = @staffing_model.mc_donell_coef * (effort * @staffing_model.standard_unit_coefficient.to_f / effort_week_unit) ** @staffing_model.puissance_n

    x0 = @staffing_model.trapeze_default_values[:x0].to_f / 100
    x1 =  @staffing_model.trapeze_default_values[:x1].to_f / 100
    x2 =  @staffing_model.trapeze_default_values[:x2].to_f / 100
    x3 =  @staffing_model.trapeze_default_values[:x3].to_f / 100
    y0 =  @staffing_model.trapeze_default_values[:y0].to_f / 100
    y3 =  @staffing_model.trapeze_default_values[:y3].to_f / 100

    staffing_trapeze = 1.5 * (effort / @md_duration * ( 1 / (x3 + x2 - x1 - x0 + y0*(x1 - x2) + y3*(x3 - x2))))

    form_coef = -Math.log(1-0.97) / (@md_duration * @md_duration)
    difficulty_coef = 2 * effort * form_coef
    t_max_staffing = Math.sqrt(1/(2*form_coef))
    staffing_rayleigh = effort / (t_max_staffing * Math.sqrt(Math.exp(1)))
%>

  <%= simple_form_for @staffing_custom_data, url: staffing.staffing_custom_datum_save_staffing_custom_data_path(@staffing_custom_data), method: :post do |f| %>

    <div class="row-fluid">

      <div class="span6">
        <table class="table">
          <tr>
            <th></th>
            <th>Standard</th>
            <th>Adapté</th>
            <th>Ecart</th>
            <th>%</th>
          </tr>
          <tr>
            <td>Effort (<%= @staffing_model.effort_unit %>)</td>
            <td>
              <span class="reference_effort">
                <%= effort.to_f.round(2) %>
              </span>
            </td>
            <td>
              <span class="effort">
                <%= @staffing_custom_data.global_effort_value %>
              </span> <%= @staffing_model.effort_unit %>
            </td>
            <td>
              <span class="gap_effort">
                <%= (effort.to_f - @staffing_custom_data.global_effort_value).round(2) %>
              </span> <%= @staffing_model.effort_unit %>
            </td>
            <td>
              <span class="percent_effort">
                <%= (effort.to_f / @staffing_custom_data.global_effort_value * 100).round(2) %>
              </span> %
            </td>
          </tr>
          <tr>
            <td>Durée (semaines)</td>
            <td>
              <span class="reference_duration">
                <%= @md_duration.to_f.round(2) %>
              </span>
            </td>
            <td>
              <span class="duration">
                <%= @staffing_custom_data.duration %>
              </span>
            </td>
            <td>
              <span class="gap_duration">
                <%= (@staffing_custom_data.duration - @md_duration.to_f).round(2) %>
              </span> semaines
            </td>
            <td>
              <span class="percent_duration">
                <%= (@staffing_custom_data.duration / @md_duration.to_f * 100).round(2) %>
              </span> %
            </td>
          </tr>
          <tr>
            <td>Trapeze</td>
            <td>
              <span class="reference_staffing_trapeze">
                <%= staffing_trapeze.to_f.round(2) %>
              </span>
            </td>
            <td>
              <span class="staffing_trapeze">
                <%= @staffing_custom_data.max_staffing.to_f.round(user_number_precision) %>
              </span>
            </td>
            <td>
              <span class="gap_trapeze">
                <%= ( @staffing_custom_data.max_staffing.to_f - staffing_trapeze.to_f).round(user_number_precision) %>
              </span>
            </td>
            <td>
              <span class="percent_trapeze">
                <%= (@staffing_custom_data.max_staffing.to_f / staffing_trapeze.to_f).round(user_number_precision) * 100 %>
              </span>
            </td>
          </tr>
          <tr>
            <td>Rayleigh</td>
            <td>
              <span class="reference_staffing_rayleigh">
                <%= staffing_rayleigh.to_f.round(2) %>
              </span>
            </td>
            <td>
              <span class="staffing_rayleigh">
                <%= @staffing_custom_data.max_staffing_rayleigh.to_f.round(user_number_precision) %>
              </span>
            </td>
            <td>
              <span class="gap_rayleigh">
                <%= (@staffing_custom_data.max_staffing_rayleigh.to_f - staffing_rayleigh).round(user_number_precision) %>
              </span>
            </td>
            <td>
              <span class="percent_rayleigh">
                <%= (@staffing_custom_data.max_staffing_rayleigh.to_f.round(user_number_precision / staffing_rayleigh) * 100).round(user_number_precision) %>
              </span>
            </td>
          </tr>
        </table>
        <input type="text" name='percents' id='percent' class="factor-slider" value="<%= @staffing_custom_data.percent %>" />

        <% if can? :execute_estimation_plan, @project %>
          <button name="actuals_based_on[custom]" type="submit" class="btn btn-mini pull-right button_margin_right">
            Valider
          </button>
        <% end %>

        <%= link_to I18n.t(:export), staffing.staffing_model_export_staffing_path(@staffing_custom_data), :method => 'post', :class=> "btn btn-mini pull-right button_margin_right"%>
      </div>

      <div class="span6">
        <div id="staffing_trapeze_chart"></div>
      </div>

      <%= hidden_field_tag "new_effort", effort, class: "new_effort" %>
      <%= hidden_field_tag "new_duration", (@staffing_custom_data.duration.nil? ? @md_duration.round(user_number_precision).to_f : @staffing_custom_data.duration.round(user_number_precision).to_f), class: "new_duration" %>
      <%= hidden_field_tag "new_staffing_rayleigh", @staffing_custom_data.max_staffing.to_f.round(user_number_precision), class: "new_staffing_rayleigh" %>
      <%= hidden_field_tag "new_staffing_trapeze", @staffing_custom_data.max_staffing_rayleigh.to_f.round(user_number_precision), class: "new_staffing_trapeze" %>

    </div>

    <script>
      $('#percent').ionRangeSlider({
          min: 70,
          max: 150,
          from: <%= @staffing_custom_data.percent.nil? ? 100 : @staffing_custom_data.percent %>,
          grid: true,
          postfix: "%",
          onChange: function (data) {
            var effort = $(".reference_effort").html();
            var duration = $(".reference_duration").html();
            var staffing_trapeze = $(".reference_staffing_trapeze").html();
            var staffing_rayleigh = $(".reference_staffing_rayleigh").html();
            var new_effort = (parseFloat(effort) / (parseFloat(data.from)) * 100);
            $(".effort").html(new_effort.toFixed(2));
            $(".new_effort").val(new_effort.toFixed(2));

            var new_duration = (duration * (parseFloat(data.from)) / 100);
            $(".duration").html(new_duration.toFixed(2));
            $(".new_duration").val(new_duration.toFixed(2));

            x0 = <%= @staffing_model.trapeze_default_values[:x0].to_f / 100 %>
            x1 = <%= @staffing_model.trapeze_default_values[:x1].to_f / 100 %>
            x2 = <%= @staffing_model.trapeze_default_values[:x2].to_f / 100 %>
            x3 = <%= @staffing_model.trapeze_default_values[:x3].to_f / 100 %>
            y0 = <%= @staffing_model.trapeze_default_values[:y0].to_f / 100 %>
            y3 = <%= @staffing_model.trapeze_default_values[:y3].to_f / 100 %>
            var new_staffing_trapeze = 1.5 * (new_effort / new_duration * ( 1 / (x3 + x2 - x1 - x0 + y0*(x1 - x2) + y3*(x3 - x2))));
            $(".staffing_trapeze").html(new_staffing_trapeze.toFixed(2));
            $(".new_staffing_trapeze").val(new_staffing_trapeze.toFixed(2));


            var form_coef = -Math.log(1-0.97) / (new_duration * new_duration);
            var difficulty_coef = 2 * new_effort * form_coef;
            var t_max_staffing = Math.sqrt(1/(2*form_coef));
            var new_staffing_rayleigh = new_effort / (t_max_staffing * Math.sqrt(Math.exp(1)))
            $(".staffing_rayleigh").html(new_staffing_rayleigh.toFixed(2));
            $(".new_staffing_rayleigh").val(new_staffing_rayleigh.toFixed(2));


            $(".percent_effort").html(((new_effort/effort)*100).toFixed(2));
            $(".percent_duration").html(((new_duration/duration)*100).toFixed(2));
            $(".percent_trapeze").html(((new_staffing_trapeze/staffing_trapeze)*100).toFixed(2));
            $(".percent_rayleigh").html(((new_staffing_rayleigh/staffing_rayleigh)*100).toFixed(2));

            $(".gap_effort").html((new_effort-effort).toFixed(2));
            $(".gap_duration").html((new_duration-duration).toFixed(2));
            $(".gap_trapeze").html((new_staffing_trapeze-staffing_trapeze).toFixed(2));
            $(".gap_rayleigh").html((new_staffing_rayleigh-staffing_rayleigh).toFixed(2));

          }
        });
    </script>
  </div>

<% end %>

<script>

  refresh_chart();

  function refresh_chart() {
    $('#staffing_trapeze_chart').highcharts({
      title: {
        text: '<%= I18n.t("Répartition des ressources en fonction du temps") %>'
      },
      xAxis: {
        min: 0,
        title: {
          text: '<%= I18n.t("Evolution du temps") %>'
        }
      },
      yAxis: {
        min: 0,
        title: {
          text: '<%= I18n.t(:staffing) %>'
        }
      },
      plotOptions: {
        column: {
          pointPadding: 0,
          borderWidth: 0
        },
        line: {
          marker: {
            enabled: false
          }
        }
      },
      series: [{
        name: "Répartition en Trapèze ajusté",
        type: 'column',
        data: <%= @staffing_custom_data.trapeze_chart_theoretical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>
      },{
        type: 'spline',
        name: "Répartition Rayleigh ajusté",
        data: <%= @staffing_custom_data.rayleigh_chart_theoretical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>,
        color: '#CC0000',
        marker: {
          enabled: false
        }
      }]
//        {
//        name: '<%#= I18n.t("Répartition en trapèze personnalisé") %>',
//        type: 'column',
//        data: <%# @staffing_custom_data.chart_actual_coordinates.map{|i| i.last.round(1)} %>,
//        color: '#7CB9E8'
//      },
//      },{
//        type: 'spline',
//        name: '<%#= I18n.t("Répartition optimal") %>',
//        data: <%#= @staffing_custom_data.mcdonnell_chart_theorical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>,
//        color: '#000000',
//        marker: {
//          enabled: false
//        }
//      }]
    });
}

</script>