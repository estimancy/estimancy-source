<h3>
  <%= I18n.t(:calculate_duration_and_size) %>
</h3>

<%
   attribute = PeAttribute.find_by_alias("effort")
   unless current_module_project.previous.first.nil?
    previous_activity = current_module_project.previous.first.wbs_activity
   end
   unless previous_activity.nil?
     begin
       ev = EstimationValue.where(:pe_attribute_id => attribute.id,
                                   :module_project_id => current_module_project.previous.first,
                                   :in_out => "output").first
     rescue
       ev = nil
     end
   else
     ev = EstimationValue.where(:pe_attribute_id => attribute.id,
                                    :module_project_id => current_module_project.id,
                                    :in_out => "input").first
   end

   if ev.nil?
     effort = 0
   else
     begin
       previous_activity_root = current_module_project.previous.first.wbs_activity.wbs_activity_elements.first.root
       effort = ev.string_data_probable[current_component.id][previous_activity_root.id][:value] / (@staffing_model.standard_unit_coefficient.nil? ? 1 : @staffing_model.standard_unit_coefficient.to_f)
     rescue
       effort = ev.string_data_probable[current_component.id] / (@staffing_model.standard_unit_coefficient.nil? ? 1 : @staffing_model.standard_unit_coefficient.to_f)
     end
   end
%>

  <%= simple_form_for @staffing_custom_data, url: staffing.staffing_custom_datum_save_staffing_custom_data_path(@staffing_custom_data), method: :post do |f| %>
    <div class="row-fluid">

      <div class="span2">
        <%= f.input :global_effort_value, label: "Effort (#{@staffing_model.effort_unit})", :input_html => { :class => 'input-medium', value: effort.nil? ? '' : effort.round(1)} %>
      </div>

      <div class="span2">
        <label class="radio">
          <input type="radio" name="option_radios" id="optionsRadios1" value="duration_constraint" <%= @staffing_custom_data.staffing_constraint == "duration_constraint" ? 'checked' : '' %>>
          <label> <%= I18n.t(:duration_in_week) %> </label>
          <%= f.input :duration, label: false, :input_html => { :class => 'input-medium', :id => "my_id1"} %>
        </label>

      </div>

      <div class="span2">
        <label class="radio">
          <input type="radio" name="option_radios" id="optionsRadios2" value="max_staffing_constraint" <%= @staffing_custom_data.staffing_constraint == "max_staffing_constraint" ? 'checked' : '' %>>
          <label>Staffing</label>
          <%= f.input :max_staffing, label: false, :input_html => { :class => 'input-medium', :id => "my_id2", disabled: true} %>
        </label>
      </div>

    </div>

    <div class="tabbable tabs-left">
      <ul id="myTab" class="nav nav-tabs">
        <li class="active"> <a datat-toggle="tab" href="#m1">Rayleigh</a></li>
        <li class=""> <a datat-toggle="tab" href="#m2">Trapeze</a></li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane active" id="m1">
          <button name="actuals_based_on[rayleigh]" type="submit" class="btn btn-success btn-mini pull-right button_margin_right">
            <%= I18n.t(:initialize_restraint) %>
          </button>

          <button name="actuals_based_on[custom]" type="submit" class="btn btn-mini pull-right button_margin_right">
            <%= I18n.t(:update) %>
          </button>

          <div class="row-fluid">
            <div class="span12">
              <h4>
                <b>
                  <%= I18n.t(:graphical_output)%>
                </b>
              </h4>
              <div class="row-fluid">
                <div class="span12">
                  <div id="staffing_trapeze_chart"></div>
                </div>
              </div>
              <h4>
                <b>
                 <%= I18n.t(:Staffing_distribution) %>
                </b>
              </h4>
              <div class="row-fluid">
                <div class="span12">

                  <% rayleigh_theoretical_coordinates = @staffing_custom_data.rayleigh_chart_theoretical_coordinates %>
                  <% actual_coordinates = @staffing_custom_data.chart_actual_coordinates %>
                  <% rayleigh_staffing_theorique = 0 %>
                  <% staffing_actuel = 0 %>

                  <% unless @staffing_custom_data.duration.nil? and @staffing_custom_data.rayleigh_duration.nil? %>
                      <table class="table table-striped table-bordered table-condensed">
                        <tr>
                          <th><%= I18n.t(:period) %></th>
                          <% for t in 0..[@staffing_custom_data.duration.to_f, @staffing_custom_data.rayleigh_duration.to_f].max %>
                              <th><%= "P#{t}" %></th>
                          <% end %>
                        </tr>

                        <tr>
                          <td>Rayleigh théorique</td>
                          <% rayleigh_theoretical_coordinates.each do |(coord,value)| %>
                              <% rounded_value = value.nil? ? 0 : value.round(1) %>
                              <% rayleigh_staffing_theorique += rounded_value %>
                              <td><%= rounded_value %></td>
                          <% end %>
                        </tr>

                        <tr>
                          <td>Nombre de personnes</td>
                          <% actual_coordinates.each do |(coord,value)| %>
                              <% rounded_value = value.nil? ? 0 : value.round(1) %>
                              <% staffing_actuel += rounded_value %>
                              <td><%= text_field_tag "actuals[#{coord}]", rounded_value, class: "input-mini" %></td>
                          <% end %>
                        </tr>
                      </table>
                  <% else %>
                      <%= I18n.t(:no_duration_established) %>
                  <% end %>
                </div>
              </div>
              <div class="row-fluid">
                <div class="span10">
                  <p>
                    <span class="badge badge-important">
                      <b>
                         <%= I18n.t(:Staffing_Rayleigh_maximum, parameter: @staffing_custom_data.max_staffing.to_f.round(1)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-important">
                      <b>
                          <%= I18n.t(:Rayleigh_effor, prameter: rayleigh_staffing_theorique.to_f.round(2)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-info">
                      <b>
                         <%= I18n.t(:effort_restraint, parameter: staffing_actuel.to_f.round(2)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-info">
                      <b>
                         <%= I18n.t(:Duration_restraint, parameter: (@staffing_custom_data.chart_actual_coordinates.size - 1).to_f.round(2)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-info">
                      <b>
                         <%= I18n.t(:Staffing_restraint, parameter: @staffing_custom_data.chart_actual_coordinates.map(&:last).max.to_f.round(2)) %>
                      </b>
                    </span>
                  </p>
                </div>
                <div class="span2">
                  <% if can? :execute_estimation_plan, @project %>
                    <button name="actuals_based_on[custom]" type="submit" class="btn btn-success btn-mini pull-right">
                     <%= I18n.t(:update_restraint_effort) %>
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="tab-pane" id="m2">
          <button name="actuals_based_on[trapeze]" type="submit" class="btn btn-success btn-mini pull-right">
            <%= I18n.t(:Initialize_from_the_Trapeze) %>
          </button>

          <button name="actuals_based_on[custom]" type="submit" class="btn btn-mini pull-right button_margin_right">
            <%= I18n.t(:update)%>
          </button>

          <div class="row-fluid">
            <div class="span12">
              <h4>
                <b>
                  <%= I18n.t(:graphical_output)%>
                </b>
              </h4>
              <div class="row-fluid">
                <div class="span12">
                  <div id="staffing_trapeze_chart2"></div>
                </div>
              </div>
              <h4>
                <b>
                  <%= I18n.t(:Staffing_distribution) %>
                </b>
              </h4>
              <div class="row-fluid">
                <div class="span12">

                  <% trapeze_theoretical_coordinates = @staffing_custom_data.trapeze_chart_theoretical_coordinates %>
                  <% actual_coordinates = @staffing_custom_data.chart_actual_coordinates %>
                  <% trapeze_staffing_theorique = 0 %>
                  <% staffing_actuel = 0 %>

                  <% unless @staffing_custom_data.duration.nil? and @staffing_custom_data.rayleigh_duration.nil? %>
                    <table class="table table-striped table-bordered table-condensed">
                      <tr>
                        <th>Période</th>
                        <% for t in 0..[@staffing_custom_data.duration.to_f, @staffing_custom_data.rayleigh_duration.to_f].max %>
                            <th><%= "P#{t}" %></th>
                        <% end %>
                      </tr>

                      <tr>
                        <td><%= I18n.t(:theoretical_trapeze) %></td>
                        <% trapeze_theoretical_coordinates.each do |(coord,value)| %>
                            <% rounded_value = value.nil? ? 0 : value.round(1) %>
                            <% trapeze_staffing_theorique += rounded_value %>
                            <td><%= rounded_value %></td>
                        <% end %>
                      </tr>

                      <tr>
                        <td><%= I18n.t(:Number_of_people) %></td>
                        <% actual_coordinates.each do |(coord,value)| %>
                          <% rounded_value = value.nil? ? 0 : value.round(1) %>
                          <% staffing_actuel += rounded_value %>
                          <td>
                            <%= text_field_tag "actuals[#{coord}]", rounded_value, class: "input-mini" %>
                          </td>
                        <% end %>
                      </tr>
                    </table>
                  <% else %>
                    <%= I18n.t(:no_duration_established) %>
                  <% end %>
                </div>
              </div>
              <div class="row-fluid">
                <div class="span10">
                  <p>
                    <span class="badge badge-important">
                      <b>
                          <%= I18n.t(:Trapeze_maximum_Staffing, parameter: @staffing_custom_data.calculated_staffing.to_f.round(1)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-important">
                      <b>
                        <%= I18n.t(:Trapèze_effort, parameter: trapeze_staffing_theorique.to_f.round(2)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-info">
                      <b>
                        <%= I18n.t(:effort_restraint, parameter: staffing_actuel.to_f.round(2)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-info">
                      <b>
                         <%= I18n.t(:Duration_restraint, parameter: (@staffing_custom_data.chart_actual_coordinates.size - 1).to_f.round(2)) %>
                      </b>
                    </span>
                  </p>

                  <p>
                    <span class="badge badge-info">
                      <b>
                          <%= I18n.t(:Staffing_restraint, parameter: @staffing_custom_data.chart_actual_coordinates.map(&:last).max.to_f.round(2)) %>
                      </b>
                    </span>
                  </p>
                </div>
                <div class="span2">
                  <% if can? :execute_estimation_plan, @project %>
                    <button name="actuals_based_on[custom]" type="submit" class="btn btn-success btn-mini pull-right">
                      <%= I18n.t(:update_restraint_effort) %>
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

<script>

  $('#optionsRadios1').click(function (e) {
    $("#my_id2").attr('disabled', "disabled")
    $("#my_id1").removeAttr('disabled')
  })
  $('#optionsRadios2').click(function (e) {
    $("#my_id1").attr('disabled', "disabled")
    $("#my_id2").removeAttr('disabled')
  })
  refresh_chart();

  $('#myTab a').click(function (e) {
    e.preventDefault();
    $(this).tab('show');
    refresh_chart();

    $.cookie("lastTab", $(this).attr('href'))

  })

  function refresh_chart() {
    $('#staffing_trapeze_chart2').highcharts({
      chart: {
        type: 'column'
      },
      title: {
        text: 'Répartition des ressources en fonction du temps'
      },
      xAxis: {
        min: 0,
        title: {
          text: 'Evolution du temps'
        }
      },
      yAxis: {
        min: 0,
        title: {
          text: 'Nombre de personnes'
        }
      },
      plotOptions: {
        column: {
          pointPadding: 0.2,
          borderWidth: 0
        }
      },
      series: [{
        name: 'Trapèze théorique',
        data: <%= @staffing_custom_data.trapeze_chart_theoretical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>
      },{
          name: 'Courbe actualisé',
          data: <%= @staffing_custom_data.chart_actual_coordinates.map{|i| i.last.round(1)} %>

        }]
    });

    $('#staffing_trapeze_chart').highcharts({
      chart: {
        type: 'column'
      },
      title: {
        text: 'Répartition des ressources en fonction du temps'
      },
      xAxis: {
        min: 0,
        title: {
          text: 'Evolution du temps'
        }
      },
      yAxis: {
        min: 0,
        title: {
          text: 'Nombre de personnes'
        }
      },
      plotOptions: {
        column: {
          pointPadding: 0.2,
          borderWidth: 0
        }
      },
      series: [{
        name: 'Rayleigh théorique',
        data: <%= @staffing_custom_data.rayleigh_chart_theoretical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>
      },{
          name: 'Courbe actualisé',
          data: <%= @staffing_custom_data.chart_actual_coordinates.map{|i| i.last.round(1)} %>

        }]
    });
  }

</script>
