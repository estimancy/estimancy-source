<!-- Si Trapèze/Linéaire : paramètres du trapèze -->
<% trapeze_parameters = @staffing_custom_data.trapeze_parameter_values %>
<div class="row-fluid">
  <div class="span2">
    <h4>
      <b>Paramètres du Trapèze (%) </b>
    </h4>
  </div>
</div>

<div class="row-fluid">
  <%= f.simple_fields_for :trapeze_parameter_values do |ff| %>
    <div class="span1"><%= ff.input :x0, label: "x0", :input_html => { value: trapeze_parameters['x0'], :class => 'input-mini'} %></div>
    <div class="span1"><%= ff.input :y0, label: "y0", :input_html => { value: trapeze_parameters[:y0], :class => 'input-mini'} %></div>
    <div class="span1"><%= ff.input :x1, label: "x1", :input_html => { value: trapeze_parameters[:x1], :class => 'input-mini'} %></div>
    <div class="span1"><%= ff.input :x2, label: "x2", :input_html => { value: trapeze_parameters[:x2], :class => 'input-mini'} %></div>
    <div class="span1"><%= ff.input :x3, label: "x3", :input_html => { value: trapeze_parameters[:x3], :class => 'input-mini'} %></div>
    <div class="span1"><%= ff.input :y3, label: "y3", :input_html => { value: trapeze_parameters[:y3], :class => 'input-mini'} %></div>
  <% end %>
</div>

<div class="row-fluid">
  <div class="span12">
    <h4>
      <b>Paramètre de Rayleigh </b>
    </h4>
  </div>
  <div class="row-fluid">
    <div class="span2"><%= f.input :staffing_constraint, as: :select, collection: [['Contrainte de staffing max', 'max_staffing_constraint'], ['Contrainte de durée', 'duration_constraint']], label: 'Contrainte imposée', include_blank: false, :input_html => { :class => 'input-medium'} %></div>
    <div class="span2"><%= f.input :max_staffing, label: "Max staffing", :input_html => { :class => 'input-medium'} %></div>
  </div>
</div>

<h4>
  <b>
    Sortie graphique
  </b>
</h4>
<!-- Affichage du trapèze de Staffing -->
<div class="row-fluid">
  <div class="span12">
    <div id="staffing_trapeze_chart">
    </div>
  </div>
</div>

<h4>
  <b>
    Répartition du staffing
  </b>
</h4>
<div class="row-fluid">
  <div class="span12">

    <% trapeze_theoretical_coordinates = @staffing_custom_data.trapeze_chart_theoretical_coordinates %>
    <% rayleigh_theoretical_coordinates = @staffing_custom_data.rayleigh_chart_theoretical_coordinates %>
    <% actual_coordinates = @staffing_custom_data.chart_actual_coordinates %>
    <% staffing_theorique = 0 %>
    <% staffing_actuel = 0 %>

    <% unless @staffing_custom_data.duration.nil? %>
      <table class="table table-striped table-bordered table-condensed">
        <tr>
          <th>Période</th>
          <% for t in 0..@staffing_custom_data.duration %>
            <th><%= "P#{t}" %></th>
          <% end %>
        </tr>

        <tr>
          <td>Trapèze théorique</td>
          <% trapeze_theoretical_coordinates.each do |(coord,value)| %>
            <% rounded_value = value.nil? ? 0 : value.round %>
            <% staffing_theorique += rounded_value %>
            <td><%= rounded_value %></td>
          <% end %>
        </tr>

        <tr>
          <td>Rayleigh théorique</td>
          <% rayleigh_theoretical_coordinates.each do |(coord,value)| %>
            <% rounded_value = value.nil? ? 0 : value.round %>
            <% staffing_theorique += rounded_value %>
            <td><%= rounded_value %></td>
          <% end %>
        </tr>

        <tr>
          <td>Actuel</td>
          <% actual_coordinates.each do |(coord,value)| %>
            <% rounded_value = value.nil? ? 0 : value.round %>
            <% staffing_actuel += rounded_value %>
            <td><%= text_field_tag "actuals[#{coord}]", rounded_value, class: "input-mini" %></td>
          <% end %>
        </tr>
      </table>
    <% else %>
      Aucune durée n'a été établie
    <% end %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">Max staffing = <%= @staffing_custom_data.max_staffing.to_i.round(1) %></div>
  <div class="span2">Staffing théorique : <%= staffing_theorique.to_i.round(2) %></div>
  <div class="span2">Staffing actuel : <%= staffing_actuel.to_i.round(2) %></div>
</div>

<script>
  $(function () {
    $('#staffing_trapeze_chart').highcharts({
      chart: {
        type: 'column'
      },
      title: {
        text: 'Répartition des ressources en fonction du temps'
      },
      subtitle: {
        text: 'Méthode du trapèze'
      },
      xAxis: {
        min: 0,
        title: {
          text: 'Evolution du temps'
        }
      },
      yAxis: {
        min: 0,
        title: {
          text: 'Nombre de personne'
        }
      },
      plotOptions: {
        column: {
          pointPadding: 0.2,
          borderWidth: 0
        }
      },
      series: [{
        name: 'Trapèze théorique',
        data: <%= @staffing_custom_data.trapeze_chart_theoretical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>

      },
      {
        name: 'Rayleigh théorique',
        data: <%= @staffing_custom_data.rayleigh_chart_theoretical_coordinates.map{|i| i.last.nil? ? 0 : i.last.round(1)} %>

      },
      {
        name: 'Courbe actualisé',
        data: <%= @staffing_custom_data.chart_actual_coordinates.map{|i| i.last.round(1)} %>

      }]
    });
  });
</script>