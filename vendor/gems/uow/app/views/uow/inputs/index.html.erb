<style>
  select, input{
    width: 100px;
  }

  .icon-center{
    padding-left: 9px;
  }

  .black-question-mark { color:black; }
  .purple-exclamation-mark { color:pink; }
  .yellow-exclamation-mark { color: #ebeb00; }
  .green-check-mark { color:green; }
  .blue-info-mark { color:blue; }
  .orange-exclamation-mark { color:orange; }
  .red-star { color:red; }

  .compressed{
    width: 40px;
  }

</style>

<div class="tabs">
  <ul>
    <li>
      <a href="#tabs-1">Units of Works Management</a>
    </li>
  </ul>

  <%= form_tag uow.save_uow_path do %>

    <%= hidden_field_tag "module_project_id", @module_project.id %>
    <div id="tabs-1" style="overflow-x: auto;">
      <table id="myTable" class="table table-striped table-bordered table-condensed ">
        <tr>
          <th colspan="6"></th>
          <th colspan="3"><%= I18n.t :quantity %></th>
          <th></th>
          <th colspan="3"> Result </th>
        </tr>
        <tr>
          <th><%= I18n.t :actions %></th>
          <th><%= I18n.t :reference %></th>
          <th><%= I18n.t :technology %></th>
          <th><%= I18n.t :unit_of_work %></th>
          <th><%= I18n.t :complexity %></th>
          <th>Type</th>
          <th>Low</th>
          <th>ML</th>
          <th>High</th>
          <th>W</th>
          <th>Low</th>
          <th>ML</th>
          <th>High</th>
        </tr>

        <tr>
          <th colspan="6">Overall</th>
          <td class="center">
            <%= text_field_tag "overall_size_low", @size.nil? ? '' : @size.string_data_low[current_component.id], :class => "overall compressed", readonly: true %>
          </td>
          <td class="center">
            <%= text_field_tag "overall_size_most_likely", @size.nil? ? '' : @size.string_data_most_likely[current_component.id], :class => "overall compressed", readonly: true %>
          </td>
          <td class="center">
            <%= text_field_tag "overall_size_high", @size.nil? ? '' : @size.string_data_high[current_component.id], :class => "overall compressed", readonly: true %>
          </td>
          <td> </td>
          <td class="center">
            <%= text_field_tag "overall_gross_low", @gross_size.nil? ? '' : @gross_size.string_data_low[current_component.id], :class => "overall compressed", readonly: true %>
          </td>
          <td class="center">
            <%= text_field_tag "overall_gross_most_likely", @gross_size.nil? ? '' : @gross_size.string_data_most_likely[current_component.id], :class => "overall compressed", readonly: true %>
          </td>
          <td class="center">
            <%= text_field_tag "overall_gross_high", @gross_size.nil? ? '' : @gross_size.string_data_high[current_component.id], :class => "overall compressed", readonly: true %>
          </td>
        </tr>

        <%= render :partial => 'row' %>
      </table>

      <%= submit_tag I18n.t(:save), :class => "btn" %>
      <%= submit_tag I18n.t(:apply), :class => "btn" %>
      <a href="#import_modal" role="button" class="btn" title="<%= I18n.t(:guide_import_wbs_activity) %>" data-toggle="modal">Importer</a>
      <%= link_to "Exporter", uow.export_path(current_module_project.id, current_component.id), :class => "btn" %>
      <%= link_to I18n.t(:back), main_app.root_url, :class => "btn" %>
      <%= submit_tag "Mettre à jour les données brutes", :class => "btn pull-right" %>

    </div>
  <% end %>

  <div id="import_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <%= form_tag uow.import_path(current_module_project.id, current_component.id), :multipart => true, :class => 'simple_form' do %>
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel"><%= I18n.t(:import) %> UO Estimation Module</h3>
      </div>
      <div class="modal-body">
        <label><%= I18n.t(:file_csv) %></label>
        <%= file_field_tag :file %>

        <label>
          <%= I18n.t(:separator) %> '<%= I18n.t(:general_csv_separator) %>')
        </label>
        <%= text_field_tag :separator %>

        <label>
          <%= I18n.t(:encoding) %>
        </label>
        <%= select_tag :encoding, options_for_select(Project::encoding, :selected => I18n.t(:general_csv_encoding)) %>

      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true"><%= I18n.t(:close) %></button>
        <%= submit_tag 'Import', :class => 'btn btn-primary', :onclick => "$('.loading').show();" %>
      </div>
      <div class="loading span11 hide">
        <h4><%= I18n.t(:please_wait_import) %>
          <%= image_tag 'ajax-loader.gif' %>
        </h4>
      </div>
    <% end %>
  </div>

  <div id="modal_description" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="myModalLabel"><%= I18n.t :how_to_use_uow %></h3>
    </div>
    <div class="modal-body">
      <% current_project.organization.unit_of_works.each do |uow| %>
        <h4><%= uow.name %></h4>
        <p>
          <%= uow.description %>
        </p>
        <p>
          <b>
            <%= I18n.t :organization_technology %> <br>
          </b>
          <%= uow.organization_technologies.map(&:name).join(', ') %>
        </p>
        <hr>
      <% end %>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true"><%= I18n.t(:close) %></button>
    </div>
  </div>

</div>

<script>
  function initialize_gross_behaviour(index){
    $(".icon-star").click(function(){
      switch(true) {
        case ($(this).hasClass('black-question-mark')):
          $(this).removeClass('black-question-mark').addClass('purple-exclamation-mark');
          $(this).next().val("purple");
          break;
        case ($(this).hasClass('purple-exclamation-mark')):
          $(this).removeClass('purple-exclamation-mark').addClass('yellow-exclamation-mark');
          $(this).next().val("yellow");
          break;
        case ($(this).hasClass('yellow-exclamation-mark')):
          $(this).removeClass('yellow-exclamation-mark').addClass('green-check-mark');
          $(this).next().val("green");
          break;
        case ($(this).hasClass('green-check-mark')):
          $(this).removeClass('green-check-mark').addClass('blue-info-mark');
          $(this).next().val("blue");
          break;
        case ($(this).hasClass('blue-info-mark')):
          $(this).removeClass('blue-info-mark').addClass('orange-exclamation-mark');
          $(this).next().val("orange");
          break;
        case ($(this).hasClass('orange-exclamation-mark')):
          $(this).removeClass('orange-exclamation-mark').addClass('red-star');
          $(this).next().val("red");
          break;
        case ($(this).hasClass('red-star')):
          $(this).removeClass('red-star').addClass('black-question-mark');
          $(this).next().val("black");
      }
    });

    var selector = "#size_low_" + index +
            ", #size_most_likely_" + index +
            ", #size_high_" + index +
            ", #weight_" + index

    $(selector).on("blur change", function(e){
      $.ajax({ url:'/uow/load_gross',
        data: 'size_low=' + $('#size_low_' + index).val()
                + '&size_most_likely=' + $('#size_most_likely_' + index).val()
                + '&size_high=' + $('#size_high_' + index).val()
                + '&weight=' + $('#weight_' + index).val()
                + '&technology=' + $('#technology_' + index).val()
                + '&uow=' + $('#uow_' + index).val()
                + '&size_unit_type=' + $('#size_unit_type_' + index).val()
                + '&complexity=' + $('#complexity_' + index).val()
                + '&index=' + $(this).closest('tr').index()
      });
    });

    $(", #uow_" + index +
      ", #technology_" + index +
      ", #complexity_" + index).on("change", function(e){

      $.ajax({ url:'/uow/load_gross',
        data: 'size_low=' + $('#size_low_' + index).val()
                + '&size_most_likely=' + $('#size_most_likely_' + index).val()
                + '&size_high=' + $('#size_high_' + index).val()
                + '&weight=' + $('#weight_' + index).val()
                + '&technology=' + $('#technology_' + index).val()
                + '&size_unit_type=' + $('#size_unit_type_' + index).val()
                + '&complexity=' + $('#complexity_' + index).val()
                + '&index=' + $(this).closest('tr').index()

      });
    });

    // Update the Unit of Works select_box according to the selected technology
    $("#technology_" + index).on("change", function(e){
        $.ajax({ url:'/uow/update_unit_of_works_select_box',
            data: 'technology_id=' + $(this).val()
                    + "&index=" + index
        });
    });

    $("#uow_" + index).on("change", function(e){
      $.ajax({ url:'/uow/update_complexity_select_box',
        data: 'uow_id=' + $(this).val()
            + "&index=" + index
      });
    });
  }

  $(document).ready(function(e){
    $("#myTable").find("tr").each(function(index){
      initialize_gross_behaviour(index);
    });
  });

</script>