<%= form_tag guw.guw_unit_of_works_save_guw_unit_of_works_path do %>

  <% @group_unit_of_works = Guw::GuwUnitOfWorkGroup.where(pbs_project_element_id: current_component.id, module_project_id: current_module_project.id) %>

    <div class="pull-right">
      <b>
        <div class="label label-info pull-right">
          Total U.F. retenu :
          <span class="ajusted_effort">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(selected: true).map{|i| i.ajusted_effort.to_f }}.flatten.sum %>
          </span>
        </div>

        <br>

        <div class="pull-left">
          Total U.F. calculés :
          <span class="label label-info theorical_effort">
              <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(selected: true).map{|i| i.effort.to_f }}.flatten.sum %>
          </span>
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. :
          <span class="label label-info number_of_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works }.flatten.size %>
          </span>
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. modifiés
          <span class="label label-info modified_of_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(flagged: true)}.flatten.size %>
          </span>
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. sélectionnés :
          <span class="label label-info selected_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(selected: true)}.flatten.size %>
          </span>
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. H.C. :
          <span class="label label-info off_line_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(off_line: true)}.flatten.size %>
          </span>
        </div>
      </b>
    </div>


  <br>
  <br>
  <hr>

  <% if @unit_of_work_groups.empty? %>
    <%= link_to I18n.t('add_new_unit_of_work_group'), guw.new_guw_unit_of_work_group_path, class: "btn btn-mini pull-left button_margin_right" %>
    <%= link_to "Créer une Unité d'Oeuvres", guw.new_guw_model_guw_unit_of_work_path(@guw_model), class: "btn btn-mini pull-left button_margin_right" %>
  <% end %>

  <div id="table_guw_model">

    <% @unit_of_work_groups.each do |uowg| %>

      <h5>
        <%= link_to uowg, guw.edit_guw_unit_of_work_group_path(uowg), title: I18n.t(:edit) %>

        <span class="pull-right">

          Total U.F. retenu :
          <span class="<%= uowg.id %>_ajusted">
            <%= uowg.guw_unit_of_works.where(selected: true).map{|i| i.ajusted_effort.to_f }.flatten.sum %>
          </span>

          - Total U.F. calculés :
          <span class="<%= uowg.id %>_theorical">
            <%= uowg.guw_unit_of_works.where(selected: true).map{|i| i.effort.to_f}.sum %>
          </span>

          - Nombre d'U.O. :
          <span class="<%= uowg.id %>_number">
            <%= uowg.guw_unit_of_works.size %>
          </span>

          - Nombre d'U.O. modifiés :
          <span class="<%= uowg.id %>_flagged">
            <%= uowg.guw_unit_of_works.where(flagged: true).size %>
          </span>

          - Nombre d'U.O. sélectionnés :
          <span class="<%= uowg.id %>_selected">
            <%= uowg.guw_unit_of_works.where(selected: true).size %>
          </span>

          / Nombre d'U.O. H.C. :
          <span class="<%= uowg.id %>_off_line">
            <%= uowg.guw_unit_of_works.where(off_line: true).size %>
          </span>
        </span>

      </h5>

      <button type="submit" class="btn btn-default btn-mini pull-right">Sauvegarder</button>
      <%= link_to "RAZ", "#", class: "btn btn-mini reset_retained button_margin_right pull-right" %>

      <%= link_to I18n.t('add_new_unit_of_work_group'), guw.new_guw_unit_of_work_group_path, class: "btn btn-mini pull-left button_margin_right" %>
      <%= link_to "Créer une Unité d'Oeuvres", guw.new_guw_model_guw_unit_of_work_path(@guw_model, g: uowg), class: "btn btn-mini pull-left button_margin_right" %>

      <table class="table table-condensed table-striped" style="margin-top: 45px;">
        <tr>
          <th></th>
          <th>S</th>
          <th>M</th>
          <th><%= I18n.t :name %></th>
          <th><%= I18n.t :description %></th>
          <th><%= I18n.t :work_unit_type %></th>
          <th><%= I18n.t :cotation %></th>
          <th><%= I18n.t :technology %></th>
          <th><%= I18n.t :tracability %></th>
          <th><%= I18n.t :cotation %></th>
          <th><%= I18n.t :results %></th>
          <th><%= I18n.t :retained_result %></th>
          <th><%= I18n.t :actions %></th>
        </tr>

        <% uowg.guw_unit_of_works.order("display_order asc").each_with_index do |guow, i| %>
          <tr>
            <td>
              <span class="label label-default">
                <%= guow.display_order %>
              </span>
            </td>

            <td>
              <%= check_box_tag 'selected', guow.id, guow.selected, class: "selected" %>
              <%= hidden_field_tag "", uowg.id, class: "#{guow.id}_group" %>
            </td>

            <td>
              <% if guow.flagged == true %>
                <span class="fa fa-star red_color"></span>
              <% else %>
                <span class="fa fa-star icon-green"></span>
              <% end %>
            </td>

            <td class="text_field_text_overflow">
              <span class="pull-left">
                <%= guow.name %>
              </span>
            </td>

            <td style="max-width: 120px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
              <span class="pull-left" >
                <%= link_to guow.comments.nil? ? '' : guow.comments.truncate(25), "#", title: guow.comments, :"data-toggle" => "modal", :"data-target" => "#comments#{guow.id}", :"data-backdrop" => "static"  %>
              </span>
              <div class="modal fade" id="comments<%= guow.id %>" tabindex="-1" role="dialog" aria-labelledby="comments_label<%= guow.id %>" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h4 class="modal-title" id="comments_label<%= guow.id %>">Attributs de <%= guow %> </h4>
                    </div>
                    <div class="modal-body">
                      <%= text_area_tag "comments[#{guow.id}]", guow.comments, class: "attribute_note_area" %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal" >Fermer</button>
                      <button type="submit" class="btn btn-default">Sauvegarder</button>
                    </div>
                  </div>
                </div>
              </div>
            </td>

            <td class="span2">
              <%= select_tag "guw_type[#{guow.id}]", options_for_select(@guw_model.guw_types.map{|i| [i.name, i.id]}, selected: guow.guw_type_id), class: "input-small", required: true %>
            </td>

            <td class="span2">
              <%= select_tag "work_unit[#{guow.id}]", options_for_select(@guw_model.guw_work_units.map{|i| [i.name, i.id]}, selected: guow.guw_work_unit_id), class: "input-small", required: true %>
            </td>

            <td class="span2">
              <%= select_tag "guw_technology[#{guow.id}]", options_for_select(@project.organization.organization_technologies.map{|i| [i.name, i.id]}, selected: guow.organization_technology.nil? ? uowg.organization_technology_id : guow.organization_technology_id), class: "input-small", required: true %>
            </td>

            <td>
              <span class="pull-left">
                <%= link_to (guow.tracking.nil? || guow.tracking.blank?) ? '--' : guow.tracking.truncate(25), "#", title: guow.tracking, :"data-toggle" => "modal", :"data-target" => "#tracking#{guow.id}", :"data-backdrop" => "static" %>
              </span>
              <div class="modal fade" id="tracking<%= guow.id %>" tabindex="-1" role="dialog" aria-labelledby="tracking_label<%= guow.id %>" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h4 class="modal-title" id="tracking_label<%= guow.id %>">Attributs de <%= guow %> </h4>
                    </div>
                    <div class="modal-body">
                      <%= text_area_tag "tracking[#{guow.id}]", guow.tracking, class: "attribute_note_area" %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal" >Fermer</button>
                      <button type="submit" class="btn btn-default">Sauvegarder</button>
                    </div>
                  </div>
                </div>
              </div>
            </td>

            <td>
              <% if guow.guw_complexity.nil? %>
                <%= link_to "------", "#", :"data-toggle" => "modal", :"data-target" => "#modal#{guow.id}" %>
              <% elsif guow.off_line == true %>
                <%= link_to "HS", "#", :"data-toggle" => "modal", :"data-target" => "#modal#{guow.id}", class: "red_color" %>
              <% else %>
                <%= link_to guow.guw_complexity.name, "#", :"data-toggle" => "modal", :"data-target" => "#modal#{guow.id}" %>
              <% end %>
            </td>

            <td>
              <%= guow.effort %>
            </td>

            <td>
              <%= text_field_tag "ajusted_effort[#{guow.id}]", guow.ajusted_effort, class: "input-mini retained" %>
            </td>

            <td>
              <%= link_to "", guw.guw_unit_of_work_up_path(guow), class: "fa fa-arrow-up" %>
              <%= link_to "", guw.guw_unit_of_work_down_path(guow), class: "fa fa-arrow-down" %>
              <%= link_to "", guw.new_guw_model_guw_unit_of_work_path(@guw_model, position: guow.display_order), class: "fa fa-plus" %>
              <%= link_to "", guw.edit_guw_model_guw_unit_of_work_path(@guw_model, guow), class: "fa fa-edit" %>
              <%= link_to "", guw.guw_unit_of_work_path(guow), method: "delete", class: "fa fa-trash" %>
            </td>

            <td>
              <div class="modal fade" id="modal<%= guow.id %>" tabindex="-1" role="dialog" aria-labelledby="myModalLabel<%= guow.id %>" aria-hidden="true" backdrop="static">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h4 class="modal-title" id="myModalLabel<%= guow.id %>">Attributs de <%= guow %> </h4>
                    </div>
                    <div class="modal-body">
                      <table class="table table-condensed table-striped">
                        <tr>
                          <th><%= I18n.t :label_PeAttribute %></th>
                          <% if @guw_model.three_points_estimation == true %>
                            <th>L</th>
                          <% end %>
                          <th>M</th>
                          <% if @guw_model.three_points_estimation == true %>
                            <th>H</th>
                          <% end %>
                        </tr>

                        <% guow.guw_unit_of_work_attributes.each_with_index do |uowa, j| %>
                          <tr>
                            <% unless guow.guw_type.nil? %>
                              <% sum_range = uowa.guw_attribute.guw_attribute_complexities.where(guw_type_id: guow.guw_type.id).map{|i| [i.bottom_range, i.top_range]}.flatten.compact %>
                            <% end %>
                            <% unless sum_range.nil? || sum_range.blank? || sum_range == 0 %>
                              <td>
                                <%= link_to uowa.guw_attribute.name, "#", title: uowa.guw_attribute.description, class: "attribute_tooltip pull-left" %>
                              </td>
                              <% if @guw_model.three_points_estimation == true %>
                                <td>
                                  <%= text_field_tag "low[#{guow.id}][#{uowa.id}]", uowa.low, class: "input-mini" %>
                                </td>
                              <% end %>
                              <td>
                                <%= text_field_tag "most_likely[#{guow.id}][#{uowa.id}]", uowa.most_likely, class: "input-mini" %>
                              </td>
                              <% if @guw_model.three_points_estimation == true %>
                                <td>
                                  <%= text_field_tag "high[#{guow.id}][#{uowa.id}]", uowa.high, class: "input-mini" %>
                                </td>
                              <% end %>
                            <% end %>
                          </tr>
                        <% end %>
                      </table>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal" >Fermer sans calculer</button>
                      <button type="submit" class="btn btn-default">Calculer</button>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        <% end %>
      </table>

      <%= link_to I18n.t('add_new_unit_of_work_group'), guw.new_guw_unit_of_work_group_path, class: "btn btn-mini pull-left button_margin_right" %>
      <%= link_to I18n.t('new_unit_of_work'), guw.new_guw_model_guw_unit_of_work_path(@guw_model), class: "btn btn-mini pull-left button_margin_right" %>

      <button type="submit" class="btn btn-default btn-mini pull-right">Sauvegarder</button>

      <br>
      <hr>

    </div>
  <% end %>


<% end %>

<script>
  $(document).ready(function () {
    $('.reset_retained').on('click', function(){
      $('.retained').val("");
    });

    $('.selected').change(function(){
      $.ajax({
        url: "<%= guw.change_selected_state_path %>",
        data: "guw_unit_of_work_id=" + this.value + "&guw_unit_of_work_group_id=" + $("." + this.value + "_group").val()
      });
    });
  });
</script>