<%= form_tag guw.guw_unit_of_works_save_guw_unit_of_works_path do %>

  <% @group_unit_of_works = Guw::GuwUnitOfWorkGroup.where(pbs_project_element_id: current_component.id, module_project_id: current_module_project.id) %>

  <div class="pull-left">
    <% if can? :execute_estimation_plan, @project %>
      <%= link_to "Gérer les groupes", guw.guw_model_guw_unit_of_work_groups_path(@guw_model), class: "btn btn-mini input-small" %>
    <% end %>
    <%= link_to "Exporter", guw.guw_model_export_path(@guw_model), class: "btn btn-mini input-small", method: "post" %>
  </div>

  <div class="pull-right">

      <div class="pull-left">
        <span class="label label-success">
        Total <%= @guw_model.retained_size_unit %> retenu :
          <span class="label label-success ajusted_effort">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(selected: true).flatten.map{|i| i.ajusted_effort.to_f }}.flatten.sum.to_f.round(3) %>
          </span>
        </span>

        <span class="label label-success">
          Total <%= @guw_model.retained_size_unit %> calculés :
          <span class="label label-success theorical_effort">
              <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(selected: true).map{|i| i.effort.to_f }}.flatten.sum.to_f.round(3) %>
          </span>
        </span>

        <span class="label label-info">
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. :
          <span class="label label-info number_of_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works }.flatten.size %>
          </span>
        </span>

        <span class="label label-info">
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. modifiés
          <span class="label label-info modified_of_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(flagged: true)}.flatten.size %>
          </span>
        </span>

        <span class="label label-info">
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. sélectionnés :
          <span class="label label-info selected_of_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(selected: true)}.flatten.size %>
          </span>
        </span>

        <span class="label label-info">
          &nbsp;&nbsp;&nbsp;&nbsp; Nombre d'U.O. H.C. :
          <span class="label label-info off_line_unit_of_work">
            <%= @group_unit_of_works.map{|i| i.guw_unit_of_works.where(off_line: true)}.flatten.size %>
          </span>
        </span>
      </div>
  </div>

  <br>
  <br>
  <hr>

  <div class="accordion" id="accordion">

  <% if @unit_of_work_groups.empty? %>
    <% if can? :execute_estimation_plan, @project %>
      <%= link_to I18n.t('add_new_unit_of_work_group'), guw.new_guw_unit_of_work_group_path, class: "btn btn-mini pull-left button_margin_right" %>
      <% unless @unit_of_work_groups.empty? %>
        <%= link_to I18n.t(:new_unit_of_work), guw.new_guw_model_guw_unit_of_work_path(@guw_model, g: uowg), class: "btn btn-mini pull-left button_margin_right" %>
      <% end %>
    <% end %>
  <% end %>

  <% @unit_of_work_groups.each_with_index do |uowg, j| %>
    <div class="accordion-heading" style="padding:5px;">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse<%=uowg.id%>" id="accordion<%=uowg.id%>">
        <div class="">
          <span style="font-weight: bold; font-size: 20px;">
            <%= uowg.name %>
          </span>
          <span class="pull-right">
            <span class="label label-success">
              Total <%= @guw_model.retained_size_unit %> retenu :
              <span class="<%= uowg.id %>_ajusted">
                <%= uowg.guw_unit_of_works.where(selected: true).map{|i| i.ajusted_effort.to_f }.flatten.sum.to_f.round(3) %>
              </span>
            </span>

            <span class="label label-success">
              Total <%= @guw_model.retained_size_unit %> calculés :
              <span class="<%= uowg.id %>_theorical">
                <%= uowg.guw_unit_of_works.where(selected: true).map{|i| i.effort.to_f}.sum.to_f.round(3) %>
              </span>
            </span>

            <span class="label label-info">
              Nombre d'U.O. :
              <span class="<%= uowg.id %>_number">
                <%= uowg.guw_unit_of_works.size %>
              </span>
            </span>

            <span class="label label-info">
              Nombre d'U.O. modifiés :
              <span class="<%= uowg.id %>_flagged">
                <%= uowg.guw_unit_of_works.where(flagged: true).size %>
              </span>
            </span>

            <span class="label label-info">
              Nombre d'U.O. sélectionnés :
              <span class="<%= uowg.id %>_selected">
                <%= uowg.guw_unit_of_works.where(selected: true).size %>
              </span>
            </span>

            <span class="label label-info">
              Nombre d'U.O. H.C. :
              <span class="<%= uowg.id %>_off_line">
                <%= uowg.guw_unit_of_works.where(off_line: true).size %>
              </span>
            </span>
          </span>
        </div>
      </a>
    </div>

    <div id="collapse<%= uowg.id %>" class="accordion-body collapse in">
      <div class="accordion-inner">
        <table class="table table-striped">
          <tr>
            <th class=""></th>
            <th class=""></th>
            <th class="">#</th>
            <th class="text_left"><%= I18n.t :name %></th>
            <th class="text_left"><%= I18n.t :description %></th>
            <th class=""><%= I18n.t :type %></th>
            <th class=""><%= "Acquisition" %></th>
            <th class=""><%= I18n.t :technology %></th>
            <th class=""><%= I18n.t :quantity %></th>
            <th class=""><%= I18n.t :complexity %></th>
            <th class=""><%= I18n.t :criteria %></th>
            <th class=""><%= I18n.t :results %></th>
            <th class=""><%= I18n.t :retained_result %></th>
            <th class=""><%= I18n.t :actions %></th>
          </tr>

          <% uowg.guw_unit_of_works.order("display_order ASC").each_with_index do |guow, i| %>
            <tr>

              <td style="border-left: 3px solid <%= (guow.flagged == true) ? 'red' : 'green' %>"></td>

              <td>
                <%= check_box_tag 'selected', guow.id, guow.selected, class: "selected", disabled: !can?(:execute_estimation_plan, @project) %>
                <%= hidden_field_tag "", uowg.id, class: "#{guow.id}_group" %>
                <%= hidden_field_tag "", guow.id, class: "#{guow.id}" %>
              </td>

              <td>
                <span class="badge badge-default">
                  <%= j %><%= guow.display_order %>
                </span>
              </td>

              <td class="text_field_text_overflow">
                <span class="pull-left">
                  <%= link_to (guow.name.nil? || guow.name.blank?) ? '-' : guow.name, guw.guw_unit_of_work_load_name_path(guow), title: guow.name, method: "post", remote: true %>
                </span>
              </td>

              <td style="max-width: 100px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
                <span class="pull-left">
                  <%= link_to (guow.comments.nil? || guow.comments.blank?) ? '-' : guow.comments.truncate(25),
                              guw.guw_unit_of_work_load_comments_path(guow),
                              title: "#{guow.comments}\n#{guow.tracking}", method: "post", remote: true %>
                </span>
              </td>

              <td class="span2 ">
                <%= select_tag "guw_type[#{guow.id}]", options_for_select( @guw_model.guw_types.map{|i| [i.name, i.id]},
                                                                           selected: guow.guw_type_id),
                               class: "guw_type input-xsmall",
                               guw: guow.id,
                               required: true,
                               readonly: !can?(:execute_estimation_plan, @project) %>
              </td>

              <td class="span2">
                <span class="work_unit_<%= guow.id %>" >
                  <% unless @guw_model.guw_work_units.map{|i| i.guw_complexity_work_units.where(guw_type_id: guow.guw_type_id).map(&:value) }.flatten.compact.empty? %>
                    <%= select_tag "guw_work_unit[#{guow.id}]", options_for_select(@guw_model.guw_work_units.order("display_order ASC").map{|i| [i.name, i.id]},
                                                                                   selected: guow.guw_work_unit_id),
                                   class: "guw_work_unit input-xsmall",
                                   guw: guow.id,
                                   required: true,
                                   readonly: !can?(:execute_estimation_plan, @project) %>
                  <% end %>
                </span>
              </td>

              <td class="span2 ">
                <span class="technology_<%= guow.id %>" >
                  <% results = Guw::GuwComplexityTechnology.where(guw_type_id: guow.guw_type_id).select{|ct| ct.coefficient != nil }.map{|i| i.organization_technology }.uniq %>
                  <% unless results.empty? %>
                    <%= select_tag "guw_technology[#{guow.id}]", options_for_select(results.map{|i| [i.name, i.id]},
                                                                                    selected: guow.organization_technology.nil? ? uowg.organization_technology_id : guow.organization_technology_id),
                                   class: "guw_technology input-xsmall",
                                   guw: guow.id,
                                   required: true,
                                   readonly: !can?(:execute_estimation_plan, @project) %>
                  <% end %>
                </span>
              </td>

              <td class="span2 quantity_label_<%= guow.id %>">
                <% unless guow.guw_type.nil? %>
                  <% if guow.guw_type.allow_quantity == true %>
                    <%= text_field_tag "quantity[#{guow.id}]", guow.quantity, class: "input-mini" %>
                  <% else %>

                  <% end %>
                <% end %>
              </td>

              <td>
                <span class=" cotation_label_<%= guow.id %>">
                  <% begin %>
                    <% if guow.off_line == true %>
                      <%= select_tag "guw_complexity_#{guow.id}", options_for_select(guow.guw_type.guw_complexities.order("display_order ASC").map{|i| [i.name, i.id] }, selected: nil), class: "input-small", prompt: "HSAT", disabled: !guow.guw_type.allow_complexity %>
                    <% elsif guow.off_line_uo == true %>
                      <%= select_tag "guw_complexity_#{guow.id}", options_for_select(guow.guw_type.guw_complexities.order("display_order ASC").map{|i| [i.name, i.id] }, selected: nil), class: "input-small", prompt: "HSUO", disabled: !guow.guw_type.allow_complexity %>
                    <% elsif guow.guw_complexity.nil? %>
                      <%= select_tag "guw_complexity_#{guow.id}", options_for_select(guow.guw_type.guw_complexities.order("display_order ASC").map{|i| [i.name, i.id] }, selected: guow.guw_complexity_id), class: "input-small", include_blank: true, disabled: !guow.guw_type.allow_complexity %>
                    <% else %>
                      <%= select_tag "guw_complexity_#{guow.id}", options_for_select(guow.guw_type.guw_complexities.order("display_order ASC").map{|i| [i.name, i.id] }, selected: guow.guw_complexity_id), class: "input-small", include_blank: true, disabled: !guow.guw_type.allow_complexity %>
                    <% end %>
                  <% rescue %>
                  <% end %>
                </span>
              </td>

              <td>
                <% unless guow.guw_type.nil? %>
                  <% if guow.guw_type.allow_criteria == true %>
                    <span class="text-center criteria_label_<%= guow.id %>">
                      <% counting = guow.guw_unit_of_work_attributes.where(guw_type_id: guow.guw_type_id).map(&:most_likely).compact %>
                      <% if counting.empty? %>
                        <%= link_to "", guw.guw_unit_of_work_load_cotations_path(guow), method: "post", remote: true, class: "fa fa-gears", style: "color: red" %>
                      <% else %>
                        <%= link_to "", guw.guw_unit_of_work_load_cotations_path(guow), method: "post", remote: true, class: "fa fa-gears", style: "color: green" %>
                      <% end %>
                    </span>
                  <% end %>
                <% end %>
              </td>

              <td>
                <span class=" effort_label_<%= guow.id %>">
                  <%= text_field_tag "effort[#{guow.id}]", guow.effort.nil? ? '' : guow.effort.round(3), class: "input-mini effort-#{uowg.id}", disabled: true %>
                </span>
              </td>

              <td>
                <% unless guow.guw_type.nil? %>
                  <span class=" ajusted_effort_<%= guow.id %>">
                    <%= text_field_tag "ajusted_effort[#{guow.id}]", guow.ajusted_effort.nil? ? '' : guow.ajusted_effort.round(3), class: "input-mini retained-#{uowg.id}", readonly: !((guow.guw_type.allow_retained == true) && can?(:execute_estimation_plan, @project)) %>
                  </span>
                <% end %>
              </td>

              <td>
                <span class="">
                  <% if can? :execute_estimation_plan, @project %>
                    <%= link_to "", guw.guw_unit_of_work_duplicate_path(guow), class: "fa fa-copy", method: "post" %>
                    <%= link_to "", guw.guw_unit_of_work_up_path(guow), class: "fa fa-arrow-up" %>
                    <%= link_to "", guw.guw_unit_of_work_down_path(guow), class: "fa fa-arrow-down" %>
                    <%= link_to "", guw.new_guw_model_guw_unit_of_work_path(@guw_model, g: uowg, position: guow.display_order), class: "fa fa-plus" %>
                    <%= link_to "", guw.edit_guw_model_guw_unit_of_work_path(@guw_model, guow, g: uowg), class: "fa fa-pencil" %>
                    <%= link_to "", guw.guw_unit_of_work_path(guow), method: "delete", confirm: I18n.t('are_you_sure'), class: "fa fa-trash" %>
                  <% end %>
                </span>
              </td>
            </tr>
          <% end %>
        </table>
      </div>
      <% if can? :execute_estimation_plan, @project %>
        <%= link_to I18n.t('add_new_unit_of_work_group'), guw.new_guw_unit_of_work_group_path, class: "btn btn-mini input-medium pull-left button_margin_right" %>
        <% unless @unit_of_work_groups.empty? %>
          <%= link_to I18n.t('new_unit_of_work'), guw.new_guw_model_guw_unit_of_work_path(@guw_model, g: uowg), class: "btn btn-mini input-medium pull-left button_margin_right" %>
        <% end %>
        <button type="submit" class="btn btn-default btn-mini input-small pull-right"><%= I18n.t(:save) %></button>
        <%= link_to "RAZ", "#!", class: "btn btn-mini input-small reset_retained button_margin_right pull-right", onclick: "raz(#{uowg.id})" %>
      <% end %>
    </div>
  <% end %>
  </div>
<% end %>

<script>
  function raz(group){
    $('.retained-' + group).val('');
    return false; // prevent default click action from happening!
    e.preventDefault();
  }

  $(document).ready(function () {

    $('.selected').change(function(){
      $.ajax({
        url: "<%= guw.change_selected_state_path %>",
        data: "guw_unit_of_work_id=" + this.value + "&guw_unit_of_work_group_id=" + $("." + this.value + "_group").val()
      });
    });

    $('.guw_type').change(function(){
      $.ajax({
        url: "<%= guw.change_cotation_path %>",
        data: "guw_type_id=" + this.value + "&guw_unit_of_work_id=" + $(this).attr("guw")
      });
    });

    $('.guw_work_unit').change(function(){
      $.ajax({
        url: "<%= guw.change_operation_path %>",
        data: "guw_work_unit_id=" + this.value + "&guw_unit_of_work_id=" + $(this).attr("guw")
      });
    });

    $('.guw_technology').change(function(){
      $.ajax({
        url: "<%= guw.change_technology_path %>",
        data: "guw_technology_id=" + this.value + "&guw_unit_of_work_id=" + $(this).attr("guw")
      });
    });
  });
</script>

<div class="modal fade" id="modal_cotation" tabindex="-1" role="dialog" aria-labelledby="modal_cotation_label" aria-hidden="true" backdrop="static">
  <div class="modal-dialog">
    <div class="modal-cotation" id="modal_cotation_content">
    </div>
  </div>
</div>

<div class="modal fade" id="modal_comments" tabindex="-1" role="dialog" aria-labelledby="modal_comments_label" aria-hidden="true" backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content" id="modal_comments_content">
    </div>
  </div>
</div>

<div class="modal fade" id="modal_trackings" tabindex="-1" role="dialog" aria-labelledby="modal_trackings_label" aria-hidden="true" backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content" id="modal_trackings_content">
    </div>
  </div>
</div>

<div class="modal fade" id="modal_name" tabindex="-1" role="dialog" aria-labelledby="modal_name_label" aria-hidden="true" backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content" id="modal_name_content">
    </div>
  </div>
</div>
