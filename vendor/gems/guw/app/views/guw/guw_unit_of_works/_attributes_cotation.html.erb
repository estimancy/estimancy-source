<%= form_tag guw.save_uo_with_multiple_outputs_path, method: "post", remote: true do %>

  <% guw_type = @guw_type.nil? ? guow.guw_type : @guw_type %>
  <%= hidden_field_tag "guw_unit_of_work_id", guow.id %>
  <%# hidden_field_tag "guw_work_unit_id", guow.guw_work_unit_id %>
  <%# hidden_field_tag "guw_weighting_id", guow.guw_weighting_id %>
  <%# hidden_field_tag "guw_factor_id", guow.guw_factor_id %>
  <%= hidden_field_tag "hidden_ajusted_size[#{guow.id}]", "" %>
  <%= hidden_field_tag "hidden_quantity[#{guow.id}]", guow.quantity %>
  <%= hidden_field_tag "hidden_technology[#{guow.id}]", guow.organization_technology %>
  <% @guw_model.guw_coefficients.each do |guw_coefficient| %>

    <% ceuw = Guw::GuwCoefficientElementUnitOfWork.where(guw_unit_of_work_id: guow.id,
                                                         guw_coefficient_id: guw_coefficient.id,
                                                         module_project_id: current_module_project.id).first %>

    <% if guw_coefficient.coefficient_type == "Liste" %>
      <%= hidden_field_tag "hidden_coefficient_element[#{guow.id}][#{guw_coefficient.id}]", guw_coefficient.id %>
    <% elsif guw_coefficient.coefficient_type == "Pourcentage" %>
      <%= hidden_field_tag "hidden_coefficient_percent[#{guow.id}][#{guw_coefficient.id}]", ceuw.nil? ? nil : ceuw.id %>
    <% elsif guw_coefficient.coefficient_type == "Coefficient" %>
      <%= hidden_field_tag "hidden_coefficient_percent[#{guow.id}][#{guw_coefficient.id}]", ceuw.nil? ? nil : ceuw.id %>
    <% else %>
      <%= hidden_field_tag "hidden_coefficient_element[#{guow.id}][#{guw_coefficient.id}]", guw_coefficient.id %>
    <% end %>

  <% end %>

  <div class="modal-header modal-drag">
    <h4 class="modal-title" id="myModalLabel<%= guow.id %>">
      <b>
        <%= guw_type %>
      </b> - <%= I18n.t(:attribute_of, parameter: guow) %> </h4>
  </div>

  <div class="modal-body" style="height: inherit;">
    <table class="table table-condensed table-striped" id="cotation">
      <tr>
        <th>
          <%= I18n.t :label_PeAttribute %>
        </th>
        <% if @guw_model.three_points_estimation == true %>
          <th>L</th>
        <% end %>
        <% if @guw_model.three_points_estimation == true %>
          <th>M</th>
        <% else %>
          <th>Valeur</th>
          <th>Commentaire</th>
        <% end %>
        <% if @guw_model.three_points_estimation == true %>
          <th>H</th>
        <% end %>
        <th></th>
      </tr>

      <% guow.guw_unit_of_work_attributes.where(guw_type_id: guw_type.id).includes(:guw_attribute).order('guw_guw_attributes.name asc').each_with_index do |uowa, j| %>
        <% gat = Guw::GuwAttributeType.where( guw_type_id: guw_type.id,
                                              guw_attribute_id: uowa.guw_attribute_id).first_or_create %>
          <tr>
            <% unless guw_type.nil? %>
              <% sum_range = uowa.guw_attribute.guw_attribute_complexities.where(guw_type_id: guw_type.id).map{|i| [i.bottom_range, i.top_range]}.flatten.compact %>
            <% end %>
            <% unless sum_range.nil? || sum_range.blank? || sum_range == 0 %>
              <td class="span3">
                <%= link_to "#{uowa.guw_attribute.name} #{gat.nil? ? nil : "(#{gat.default_value.to_i})"}", "#", title: uowa.guw_attribute.description, class: "attribute_tooltip pull-left", :"default_value_#{guow.id}][#{uowa.id}" => gat.default_value.to_i  %>
              </td>

              <% if @guw_model.three_points_estimation == true %>
                <td class="span1">
                  <%= text_field_tag "low[#{guow.id}][#{uowa.id}]", uowa.low, class: "input-mini", readonly: !can?(:execute_estimation_plan, @project) %>
                </td>
              <% end %>

              <td class="span1">
                <%= text_field_tag "most_likely[#{guow.id}][#{uowa.id}]", uowa.most_likely.nil? ? (gat.nil? ? nil : gat.default_value) : uowa.most_likely, class: "input-mini ml_#{uowa.id}", default_value: gat.default_value.to_i, readonly: !can?(:execute_estimation_plan, @project) %>
              </td>
              <td>
                <%= link_to (uowa.comments.blank? ? '...' : uowa.comments.to_s.truncate(30)), "#!", class: "comments attribute_tooltip", id: "preview_comment_#{guow.id}_#{uowa.id}", title: raw(simple_format(uowa.comments.to_s)) %>
                <%# text_field_tag "comments[#{guow.id}][#{uowa.id}]", uowa.comments, class: "input-large pull-left comments", readonly: !can?(:execute_estimation_plan, @project), placeholder: "Votre commentaire", style: "text-align: left;" %>
              </td>

              <td>
                <div class="modal fade modal_comments" tabindex="-1" role="dialog" id="modal_comments_<%= guow.id %>_<%= uowa.id %>" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header modal-drag">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">
                          Commentaire
                        </h4>
                      </div>

                      <div class="modal-body" style="height: inherit;">
                        <%= text_area_tag "comments[#{guow.id}][#{uowa.id}]", (uowa.comments.blank? ? nil: raw(uowa.comments)), class: "tinymce optional rich_comment_area_#{uowa.id}", rows: "10", readonly: !can?(:execute_estimation_plan, @project), placeholder: "" %>
                      </div>

                      <div class="modal-footer">
                        <%= link_to "OK", "#!", :class => 'btn btn-primary validate', onclick: "yolo(#{uowa.id});" %>
                      </div>
                    </div>
                  </div>
                </div>
              </td>

              <script>
                var content = "";

                $("#preview_comment_" + <%= guow.id %> + "_" + <%= uowa.id %>).on('click', function(e) {
                  $("#modal_comments_" + <%= guow.id %> + "_" + <%= uowa.id %>).modal({
                    keyboard: false,
                    backdrop: "static"
                  });
                });

                function yolo(uowa_id){
                  $('.modal_comments').modal('hide');
                  $('#preview_comment_' + <%= guow.id %> + "_" + uowa_id).html(tinymce.get('comments_' + <%= guow.id %> + '_' + uowa_id).getContent());
                };

                $(".ml").on('focus', function(e) {
                  $(".submit_cotation").attr('disabled', 'disabled');
                  $(".comments").keyup(function(e) {
                    if ($(this).val().length == 0) {
                      $(".submit_cotation").attr('disabled', 'disabled');
                    } else {
                      $(".submit_cotation").removeAttr('disabled');
                    }
                  });
                });

                $(".ml_" + <%= uowa.id %>).on('blur', function(k) {
                  var val = $('#most_likely_' + <%= guow.id %> + "_" + <%= uowa.id %>).val();
                  if (val.length == 0) {
                    $(".submit_cotation").attr('disabled', 'disabled');
                  } else {
                    $(".submit_cotation").removeAttr('disabled');
                  }

                  valu = $(this).val();
                  dv = $(this).attr("default_value");

                  if(valu == dv) {
                    $(".submit_cotation").removeAttr('disabled');
                  } else {
                    $("#modal_comments_" + <%= guow.id %> + "_" + <%= uowa.id %>).modal({
                      keyboard: false,
                      backdrop: "static"
                    });
                  }

                });
              </script>

              <% if @guw_model.three_points_estimation == true %>
                <td>
                  <%= text_field_tag "high[#{guow.id}][#{uowa.id}]", uowa.high, class: "input-mini", readonly: !can?(:execute_estimation_plan, @project) %>
                </td>
              <% end %>

            <% end %>
          </tr>
      <% end %>
    </table>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-default" data-dismiss="modal" >
        <%= I18n.t(:close_without_calculate) %>
    </button>
    <% if can? :execute_estimation_plan, @project %>
      <button type="submit" class="btn btn-primary submit_cotation" data-disable-with="Veuillez patienter... <i class='fa fa-spinner fa-spin'></i>"><%= I18n.t(:calculate) %></button>
    <% end %>
  </div>

<% end %>

<%= tinymce %>

<script>
  $(document).ready(function() {
    $('.attribute_tooltip').tooltip({'html' : true });
  });
</script>
