
<div class="row pb-5">
  <div class="col-12">
    <section class="card card-content-bloc estimancy-form">

      <div class="mb-5">
        <div class="effort-bloc">

          <br>

          <ul class="nav nav-pills tabs" id="pills-tab" role="tablist">

            <li class="nav-item">
              <a class="nav-link show active"  data-toggle="pill" id="tabs-model_tab" href="#tabs-model" role="tab" aria-selected="true">Propriétés</a>
            </li>

            <% unless @guw_model.new_record? %>
              <li class="nav-item">
                <a class="nav-link"  data-toggle="pill" id="tabs-attributs_tab" href="#tabs-attributs" role="tab" aria-selected="false">Attributs</a>
              </li>

              <li class="nav-item">
                <a class="nav-link"  data-toggle="pill" id="tabs-coefficients_tab" href="#tabs-coefficients" role="tab" aria-selected="false">Coefficients</a>
              </li>

              <li class="nav-item">
                <a class="nav-link"  data-toggle="pill" id="tabs-output_tab" href="#tabs-output" role="tab" aria-selected="false">Sorties</a>
              </li>
            <% end  %>
          </ul>

          <br>
          <hr>

          <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="tabs-model" role="tabpanel" aria-labelledby="tabs-model_tab">
              <div class="card-body">
                <div class="edition-bloc-left">
                  <div class="edition-bloc-content">

                    <div class="edition-bloc-form">

                      <% unless @guw_model.new_record? %>
                        <div class="group_button">
                          <% if @guw_model.config_type == "new" %>
                            <%= link_to I18n.t(:export), guw.guw_model_export_new_config_path(@guw_model), :method => 'post', :class => 'btn btn-secondary btn-estimancy' %>
                          <% else %>
                            <%= link_to I18n.t(:export), guw.guw_model_export_old_config_path(@guw_model), :method => 'post', :class => 'btn btn-secondary btn-estimancy' %>
                          <% end %>

                          <% if @guw_model.default_display == "tab" %>
                            <%#= link_to I18n.t(:see_model), guw.guw_model_path(@guw_model), :class => 'btn btn-secondary btn-estimancy' %>
                              <% unless @guw_model.guw_types.empty? %>
                                <%= link_to I18n.t(:see_model), guw.guw_type_path(@guw_model.guw_types.first), :class => 'btn btn-secondary btn-estimancy', confirm: I18n.t(:warning_edit_instance_module) %>
                              <% end %>
                          <% else %>
                            <%= link_to I18n.t(:see_model), guw.guw_model_all_guw_types_path(@guw_model, organization_id: @current_organization.id), :class => 'btn btn-secondary btn-estimancy' %>
                          <% end %>

                        </div>
                      <% else %>
                        <a href="#import" role="button" class="btn btn-primary float-md-right" title="<%= I18n.t(:import_uo_from_excel)%>" data-toggle="modal">
                          <%= I18n.t(:import) %>
                        </a>
                        <div id="import" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                          <%= form_tag guw.import_new_config_path, :method => 'post', :multipart => true, :class => 'simple_form' do %>
                            <div class="modal-header modal-drag">
                              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                              <h3 id="myModalLabel"> <%= I18n.t(:import_from) %></h3>
                            </div>
                            <div class="modal-body">
                              <%= file_field_tag :file %>
                            </div>
                            <div class="modal-footer">
                              <button class="btn" data-dismiss="modal" aria-hidden="true">Fermer</button>
                              <%= submit_tag I18n.t(:import), :class => 'btn btn-primary', :onclick => "$('.loading').show();" %>
                            </div>
                            <div class="loading span11 hide">
                              <h4><%= I18n.t(:please_wait_import) %><%= image_tag 'ajax-loader.gif' %></h4>
                            </div>
                          <% end %>
                        </div>
                      <% end %>

                        <%= simple_form_for(@guw_model) do |f| %>
                          <%= f.error_notification %>
                          <%= f.input :organization_id, as: :hidden, input_html: { value: @organization.id } %>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :name, label: false, :input_html => { :class => 'mdl-textfield__input', :autofocus => (controller.action_name == 'new')} %>
                              <label class="mdl-textfield__label" for="name"><%= I18n.t(:name) %></label>
                            </div>
                          </div>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :description, label: false, input_html: { class: 'mdl-textfield__input'} %>
                              <label class="mdl-textfield__label" for="description"><%= I18n.t(:description) %></label>
                            </div>
                          </div>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :config_type, as: :select, collection: [["#{I18n.t :old_configuration}", "old"], ["#{I18n.t :new_configuration}", "new"]], label: "#{I18n.t :type_of_configuration}", input_html: { class: "form-control", rows: "5" } %>
                            </div>
                          </div>

                          <div class="form-row">
                            <div class="col-5">
                              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                <%= f.input :view_data, as: :boolean, label: false, :input_html => {:class => 'mdl-checkbox__inputs'}  %> <%# Activer la visualiation des données %>
                                <label class="mdl-textfield__label" for="view_data" style="padding-left: 20px; margin-top: -7px;"><%= "#{I18n.t :enable_data_visualization}" %></label>
                              </div>
                            </div>
                          </div>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :default_display, as: :select, collection: [["Liste", "list"], ["Onglet", "tab"]], label: I18n.t(:display_default), input_html: { class: "form-control", rows: "5" } %>
                            </div>
                          </div>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :three_points_estimation, label: false, :input_html => {:class => 'mdl-checkbox__inputs'}   %>
                              <label class="mdl-textfield__label" for="three_points_estimation" style="padding-left: 20px; margin-top: -7px;"><%= I18n.t(:three_points_estimation) %></label>
                            </div>
                          </div>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :retained_size_unit, label: false, :input_html => { :class => 'mdl-textfield__input'} %>
                              <label class="mdl-textfield__label" for="retained_size_unit"><%= I18n.t(:retained_size_unit) %></label>
                            </div>
                          </div>

                          <div class="col-5">
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                              <%= f.input :hour_coefficient_conversion, label: false, :input_html => { :class => 'mdl-textfield__input'} %>
                              <label class="mdl-textfield__label" for="hour_coefficient_conversion"><%= I18n.t(:hour_coefficient_conversion) %></label>
                            </div>
                          </div>

                          <%# Configuration du type d'import %>
                          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                            <h5><%= I18n.t :configuration_of_the_import_type %></h5>
                          </div>

                          <br>

                          <div style="display: flex;">
                            <table class="table table-list">
                              <thead>
                                <tr>
                                  <th><%= I18n.t :enable_import %></th>   <%# Activer Import %>
                                  <th><%= I18n.t :IA_server %></th>       <%# Seveur IA %>
                                  <th><%= I18n.t :IA_optional %></th>     <%# IA facultatif %>
                                </tr>
                              </thead>

                              <tbody>
                              <tr>
                                <td><%= f.input :allow_excel, label: "#{I18n.t :enable_import_via_excel}" %></td> <%# Activer l'import par Excel %>
                                <td><%= f.input :excel_ml_server, label: false, placeholder: "#{I18n.t :server_address}", disabled: !@guw_model.allow_excel %></td> <%# Adresse du serveur %>
                                <td><%= f.input :allow_ml_excel, label: "IA Optionnelle" %></td>
                              </tr>
                              <tr>
                                <td><%= f.input :allow_jira, label: "#{I18n.t :enable_import_via_jira}" %></td>
                                <td><%= f.input :jira_ml_server, label: false , placeholder: "#{I18n.t :server_address}", disabled: !@guw_model.allow_jira  %></td>
                                <td><%= f.input :allow_ml_jira, label: "IA Optionnelle" %></td>
                              </tr>
                              <tr>
                                <td><%= f.input :allow_redmine, label: "#{I18n.t :enable_import_via_Redmine}" %></td>
                                <td><%= f.input :redmine_ml_server, label: false, placeholder: "#{I18n.t :server_address}", disabled: !@guw_model.allow_redmine %></td>
                                <td><%= f.input :allow_ml_redmine, label: "IA Optionnelle" %></td>
                              </tr>
                              </tbody>
                            </table>
                          </div>

                          <hr />

                          <script>

                            //       # Si activer import cochée => On dégrise colonne milieu et droite
                            //       # Sinon colonnes 2 et 3 grisées.
                            //       # ou inverse

                            $(document).ready(function() {

                                $('#guw_model_allow_excel').change(function() {
                                    if($(this).is(":checked")) {
                                        $('#guw_model_excel_ml_server').removeAttr("disabled", "true");
                                        $('#guw_model_allow_ml_excel').removeAttr("disabled", "true");

                                    } else {
                                        $('#guw_model_excel_ml_server').attr("disabled","false");
                                        $('#guw_model_allow_ml_excel').attr("disabled","false");
                                    }

                                });
                            });


                            $('#guw_model_allow_jira').change(function() {
                                if($(this).is(":checked")) {
                                    $('#guw_model_jira_ml_server').removeAttr("disabled", "true");
                                    $('#guw_model_allow_ml_jira').removeAttr("disabled", "true");

                                } else {
                                    $('#guw_model_jira_ml_server').attr("disabled","false");
                                    $('#guw_model_allow_ml_jira').attr("disabled","false");
                                }

                            });


                            $('#guw_model_allow_redmine').change(function() {
                                if($(this).is(":checked")) {
                                    $('#guw_model_redmine_ml_server').removeAttr("disabled", "true");
                                    $('#guw_model_allow_ml_redmine').removeAttr("disabled", "true");

                                } else {
                                    $('#guw_model_redmine_ml_server').attr("disabled","false");
                                    $('#guw_model_allow_ml_redmine').attr("disabled","false");
                                }

                            });



                            // function grise(element) {
                            //         var text = document.getElementById(element);
                            //         if(text.disabled == true)
                            //                 text.disabled = false;
                            //         else
                            //                 text.disabled = true;
                            // }

                            // $('#guw_model_allow_excel').click(function(){
                            //   $('guw_model_excel_ml_server').attr('disabled', $(this).attr('checked'));
                            // });



                            // $("#guw_model_allow_excel").onClick(function() {
                            //   if ($("#guw_model_allow_excel").val() == true)
                            //      $("#guw_model_excel_ml_server").disabled();

                            //   else
                            // alert('bb');
                            // });



                            $("#guw_model_excel_ml_server").keyup(function() {
                                if($("#guw_model_excel_ml_server").val() != "")
                                    $(".allow_ml_excel").show();
                                else
                                    $(".allow_ml_excel").hide();
                            });

                            $("#guw_model_jira_ml_server").keyup(function() {
                                if($("#guw_model_jira_ml_server").val() != "")
                                    $(".allow_ml_jira").show();
                                else
                                    $(".allow_ml_jira").hide();
                            });

                            $("#guw_model_redmine_ml_server").keyup(function() {
                                if($("#guw_model_redmine_ml_server").val() != "")
                                    $(".allow_ml_redmine").show();
                                else
                                    $(".allow_ml_redmine").hide();
                            });
                          </script>

      <!--                </div>-->

                          <table class="table table-list">
                            <thead>
                              <tr>
                                <th>
                                  Position
                                </th>
                                <th>
                                  <%= I18n.t :column %>
                                </th>
                              </tr>
                            </thead>

                            <% @initial_guw_model_orders = @guw_model.orders %>
                            <% @guw_model_orders = @initial_guw_model_orders.delete_if { |k, v| v.blank? } %>
                            <% @guw_model_orders = @guw_model_orders.sort_by{ |k,v| v.to_f }.to_h %>

                            <% all_coeff_and_outputs = (@guw_model.guw_coefficients.map(&:name) + @guw_model.guw_outputs.map(&:name) + ["#{I18n.t :criteria}", "#{I18n.t :cplx_coeff}", "#{I18n.t(:coefficient)}"]).flatten %>
                            <% all_coeff_and_outputs.each do |key|
                              unless @guw_model_orders.key?("#{key}")
                              @guw_model_orders["#{key}"] = nil
                            end
                          end
                          %>

                          <% @guw_model_orders.each do |item, value| %>
                            <tbody>
                            <tr>
                              <% begin %>

                                <td>
                                  <%= text_field_tag "items[#{item}]", value, class: "order_size" %>
                                </td>

                                <% if item == "#{I18n.t :coefficient}" || item == "#{I18n.t :coeff_complexity}"  || item == "#{I18n.t :criteria}" %>
                                  <td class="orders_padding">
                                    <b>
                                      <%= item %>
                                    </b>
                                  </td>
                                <% else %>
                                  <td class="orders_padding">
                                    <%= item %>
                                  </td>
                                <% end %>

                              <% rescue %>
                                <td>
                                  <%#= text_field_tag "items[#{item}]", YAML::load(@guw_model.orders.value)[item], class: "order_size" %>
                                  <%= text_field_tag "items[#{item}]", YAML::load(@guw_model_orders.value)[item], class: "order_size" %>
                                </td>

                                <% if item == "#{I18n.t :coefficient}" || item == "#{I18n.t :coeff_complexity}"  || item == "#{I18n.t :criteria}" %>
                                  <td class="orders_padding">
                                    <b>
                                      <%= item %>
                                    </b>
                                  </td>
                                <% else %>
                                  <td class="orders_padding">
                                    <%= item %>
                                  </td>
                                <% end %>

                                <% end %>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>

                        <div class="actions-tabs">
                          <% if can? :manage_modules_instances, ModuleProject %>
                            <%= f.button :submit, I18n.t('save'), class: "btn btn-primary" %>
                            <%= f.button :submit, I18n.t('apply'), class: "btn btn-primary" %>
                          <% end %>
                          <%= link_to I18n.t(:back), main_app.organization_module_estimation_path(@current_organization, anchor: "taille"), class: "btn btn-secondary" %>
                        </div>
                        <% end %>
                    </div>
                  </div>
                </div>
              </div>
          </div>

          <% unless @guw_model.new_record? %>
              <div class="tab-pane fade" id="tabs-attributs" role="tabpanel" aria-labelledby="tabs-attributs_tab">
                <div class="card-body">
                  <div class="edition-bloc-left">
                    <div class="edition-bloc-content">

                      <table class="table table-bordered">
                        <tr>
                          <th><%= I18n.t(:name) %></th>
                          <th><%= I18n.t(:description) %></th>
                          <th><%= I18n.t(:audit_action) %></th>
                        </tr>

                        <% @guw_attributes.each do |guw_attribute| %>
                          <tr>
                            <td><%= guw_attribute.name %></td>
                            <td><%= guw_attribute.description %></td>
                            <td class="center">
                              <%= link_to raw("<i class='material-icons'>edit</i>"), guw.edit_guw_model_guw_attribute_path(@guw_model, guw_attribute), :class => 'material-icons', :title => I18n.t('edit') %>
                              <% if can? :manage_modules_instances, ModuleProject %>
                                <%= link_to raw("<i class='material-icons'>delete</i>"), guw_attribute, confirm: I18n.t(:are_you_sure), :class => 'material-icons', :title => I18n.t('delete'), method: "DELETE" %>
                            <% end %>
                            </td>
                          </tr>
                        <% end %>
                      </table>

                      <div class="actions-tabs">
                        <% if can? :manage_modules_instances, ModuleProject %>
                          <%= link_to I18n.t(:create_button), guw.new_guw_model_guw_attribute_path(@guw_model), class: "btn btn-primary" %>
                        <% end %>
                        <%= link_to I18n.t(:back) , guw.guw_model_path(@guw_model), class: "btn btn-secondary" %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="tabs-output" role="tabpanel" aria-labelledby="tabs-output_tab">
                <div class="card-body">
                  <div class="edition-bloc-left">
                    <div class="edition-bloc-content">

                        <div class="span9">
                          <table class="table table-list">
                              <tr>
                                <th><%= I18n.t(:name) %></th>
                                <th class="span2">Type de sortie</th>
                                <th class="span2">Unité de sortie</th>
                                <th class="span2">Sous-total</th>
                                <th class="span2">Couleur</th>
                                <th class="span2">Priorité de la couleur</th>
                                <th class="span2">Coefficient Standard</th>
                                <th class="span2">Ordre de calcul</th>
                                <th>Actions</th>
                              </tr>

                            <% unless @guw_outputs.empty? %>
                              <% @guw_outputs.each do |guw_output| %>
                                  <tr>
                                    <td class="align-center">
                                      <%= link_to guw_output.name, guw.edit_guw_model_guw_output_path(@guw_model, guw_output) %>
                                    </td>
                                    <td class="align-center"><%= guw_output.output_type %></td>
                                    <td class="align-center"><%= guw_output.unit %></td>
                                    <td class="align-center"><%= guw_output.allow_subtotal %></td>
                                    <td class="align-center" style='width: 10%; background-color: <%= "##{guw_output.color_code}" %>'>
                                      <%= guw_output.color_code %>
                                    </td>
                                    <td class="align-center"><%= guw_output.color_priority %></td>
                                    <td class="align-center"><%= guw_output.standard_coefficient %></td>
                                    <td class="align-center"><%= guw_output.display_order %></td>
                                    <td class="center">
                                      <%= link_to raw("<i class='material-icons'>edit</i>"), guw.edit_guw_model_guw_output_path(@guw_model, guw_output), :class => 'material-icons', :title => I18n.t('edit') %>
                                      <% if can? :manage_modules_instances, ModuleProject %>
                                        <%= link_to raw("<i class='material-icons'>delete</i>"), guw.guw_model_guw_output_path(@guw_model, guw_output), confirm: I18n.t(:are_you_sure), :class => 'material-icons', :title => I18n.t('delete'), method: "DELETE" %>
                                      <% end %>
                                    </td>
                                  </tr>
                                <% end %>
                              <% end %>
                          </table>
                        </div>


                      <br>

                      <% if can? :manage_modules_instances, ModuleProject %>
                        <%= link_to "#{I18n.t(:create_button)}", guw.new_guw_model_guw_output_path(@guw_model), class: "btn btn-primary" %>
                      <% end %>
                      <%= link_to I18n.t(:back) , guw.guw_model_path(@guw_model), class: "btn btn-secondary" %>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="tabs-coefficients" role="tabpanel" aria-labelledby="tabs-coefficients_tab">

                <div class="row pb-5" style="margin-top:2rem">

                  <div class="col-9">

                    <div id="guw_coefficients_tab">
                      <% if @guw_coefficient %>
                        <%= render :partial => "guw/guw_coefficients/show", object: [@guw_coefficient] %>
                      <% end %>
                    </div>

                    <% if can? :manage_modules_instances, ModuleProject %>
                      <%= link_to "Nouveau coefficient", guw.new_guw_model_guw_coefficient_path(@guw_model), class: "btn btn-primary" %>
                    <% end %>

                    <%= link_to I18n.t(:back), guw.guw_model_path(@guw_model) , class: "btn btn-secondary" %>

                  </div>

                  <div class="col-3">
                    <div id="edition-sidebar">
                      <h4 class="mb-0"><%= I18n.t(:coefficients_list) %></h4>
                      <ul class="nav" style="display: block;">
                        <% @guw_coefficients.each do |guw_coefficient| %>
                          <li class="nav-item">
                            <a class="nav-link group" href="<%= guw.guw_model_guw_coefficient_path(@guw_model, guw_coefficient) %>"  data-remote="true">
                              <span>
                                <%= guw_coefficient.name %> (<%= guw_coefficient.coefficient_type %>)
                              </span>
                            </a>
                          </li>
                        <% end %>
                      </ul>
                    </div>
                  </div>
                </div> <!-- end of row pb-5 -->

              </div> <!-- end of Div coefficients -->
            <% end %>
          </div>

        </div>
      </div>
    </section>
  </div>

</div>