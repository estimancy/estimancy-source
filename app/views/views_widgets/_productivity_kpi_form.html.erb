<section class="card card-content-bloc estimancy-form">
    <%= simple_form_for(@views_widget, is_label_widget: true) do |f| %>
      <div class="card-body">
        <div class="edition-bloc-content">
          <div class="edition-bloc-form">

            <% output_type_collection = Iwidget.output_types #[[I18n.t(:first_value), "first_value"], [I18n.t(:last_value), "last_value"], [I18n.t(:table_values), "table_values"], [I18n.t(:line_chart), "line_chart"], [I18n.t(:bar_chart), "bar_chart"], [I18n.t(:stacked_bar_chart), "stacked_bar_chart"], [I18n.t(:pie_chart), "pie_chart"]] %>

            <%= f.error_notification %>
            <%= f.input :view_id, as: :hidden, :input_html => { value: @view_id } %>
            <%= f.input :position_x, as: :hidden, :input_html => { value: @position_x } %>
            <%= f.input :position_y, as: :hidden, :input_html => { value: @position_y } %>

            <%= hidden_field_tag 'current_module_project_id', @module_project.id %>
            <%= f.input :is_organization_kpi_widget, as: :hidden, :input_html => { value: true } %>
            <%= f.input :widget_type, as: :hidden, input_html: { value: "text" } %>

            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.input :name, label: false, :input_html => { :class => 'mdl-textfield__input form-control' } %>
                  <label class="mdl-textfield__label" for="name"><%= I18n.t(:name) %></label>
                </div>
              </div>

              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.input :position, label: false, :input_html => { :class => 'mdl-textfield__input form-control' } %>
                  <label class="mdl-textfield__label" for="position"><%= I18n.t(:position) %></label>
                </div>
              </div>
            </div>

            <!-- SERIES-->


            <!-- SERIE A -->
            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.association :serie_a_kpi, label: false, collection: @current_organization.kpis, prompt: I18n.t(:choose_indicator),
                                    include_blank: true, input_html: { class: "inline_attr mdl-textfield__input form-control" } %>
                  <label class="mdl-textfield__label" for="module_project"><%= "Serie A" %></label>
                </div>
              </div>

              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <%= f.input :serie_a_output_type,
                                :label => false,
                                :as => :select,
                                :collection => output_type_collection,
                                :input_html => { :class => 'inline_attr mdl-textfield__input form-control' },
                                include_blank: false %>
                    <label  class="mdl-textfield__label" for="output_type"><%= "Serie A : #{I18n.t('output_type')}"  %></label>
                </div>
              </div>
            </div>

            <!-- SERIE B -->
            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.association :serie_b_kpi, label: false, collection: @current_organization.kpis, prompt: I18n.t(:choose_indicator),
                                    include_blank: true, input_html: { class: "inline_attr mdl-textfield__input form-control" } %>
                  <label class="mdl-textfield__label" for="module_project"><%= "Serie B" %></label>
                </div>
              </div>

              <div class="col-6 select-estimancy">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <label class="mdl-textfield__label" for="output_type"><%= "Serie B : #{I18n.t('output_type')}" %></label>
                    <%= f.input :serie_b_output_type,
                                :label => false,
                                :as => :select,
                                :collection => output_type_collection,
                                :input_html => { :class => 'inline_attr mdl-textfield__input form-control' },
                                include_blank: true %>
                </div>
              </div>
            </div>



            <!-- SERIE C -->
            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.association :serie_c_kpi, label: false, collection: @current_organization.kpis, prompt: I18n.t(:choose_indicator),
                                    include_blank: true, input_html: { class: "inline_attr mdl-textfield__input form-control" } %>
                  <label class="mdl-textfield__label" for="module_project"><%= "Serie C" %></label>
                </div>
              </div>

              <div class="col-6 select-estimancy">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <label class="mdl-textfield__label" for="output_type"><%= "Serie C : #{I18n.t('output_type')}"  %></label>
                    <%= f.input :serie_c_output_type,
                                :label => false,
                                :as => :select,
                                :collection => output_type_collection,
                                :input_html => { :class => 'mdl-textfield__input form-control' },
                                include_blank: true %>
                </div>
              </div>
            </div>


            <!-- SERIE D -->
            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.association :serie_d_kpi, label: false, collection: @current_organization.kpis, prompt: I18n.t(:choose_indicator), include_blank: true, input_html: { class: "inline_attr mdl-textfield__input form-control" } %>
                  <label class="mdl-textfield__label" for="module_project"><%= "Serie D" %></label>
                </div>
              </div>

              <div class="col-6 select-estimancy">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <label class="mdl-textfield__label" for="output_type"><%= "Serie D : #{I18n.t('output_type')}"  %></label>
                    <%= f.input :serie_d_output_type,
                                :label => false,
                                :as => :select,
                                :collection => output_type_collection,
                                :input_html => { :class => 'mdl-textfield__input form-control' },
                            include_blank: true %>
                </div>
              </div>
            </div>

            <!-- Fin de serie -->
            <div class="form-row">
              <div class="col-8">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.input :end_of_series, label: false,
                              collection: [[I18n.t(:end_of_series), "end_of_series"], [I18n.t(:project_date_included), "project_date_included"], [I18n.t(:project_date_not_included), "project_date_not_included"],  ["Date du jour", "current_date"]],
                              include_blank: false, input_html: { class: "inline_attr mdl-textfield__input form-control" } %>
                  <label class="mdl-textfield__label" for="module_project">
                    <%= I18n.t(:end_of_series) %>
                  </label>
                </div>
              </div>
            </div>

            <!-- END SERIES -->
            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.input :x_axis_label, label: false, :input_html => { :class => 'mdl-textfield__input form-control' } %>
                  <label class="mdl-textfield__label" for="x_axis_label"><%= I18n.t(:x_axis_label) %></label>
                </div>
              </div>

              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.input :y_axis_label, label: false, :input_html => { :class => 'mdl-textfield__input form-control' } %>
                  <label class="mdl-textfield__label" for="y_axis_label"><%= I18n.t(:y_axis_label) %></label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="col-6">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <label class="mdl-textfield__label" for="color"><%= I18n.t(:status_color) %></label>
                  <% if @views_widget.new_record? %>
                      <%= f.input :color, label: false, input_html: { value: "blanchedalmond", class: "color mdl-textfield__input form-control"} %>
                  <% else %>
                      <%= f.input :color, label: false, input_html: { class: "color mdl-textfield__input form-control"}  %>
                  <% end %>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="col-4">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <%= f.input :kpi_unit, label: false, input_html: { class: "kpi_margin_top"} %>
                  <label class="mdl-textfield__label" for="kpi_unit"><%= I18n.t(:kpi_unit) %></label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="col-4">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <% selected = @views_widget.project_fields.first %>
                  <%= select_tag "field", options_for_select(@project.organization.fields.map{|i| [i.name, i.id] }, selected: selected.nil? ? '' : selected.field.id), prompt: "None",
                                 disabled: (!(@views_widget.widget_type == "text")  || @views_widget.is_label_widget?), class: "field_margin_top"%>
                  <label class="mdl-textfield__label" for="fields"><%= I18n.t(:fields) %></label>
                </div>
              </div>
            </div>

            <div class="row-fluid">
              <div class="col-6">
                <% if can?(:alter_estimation_plan, @project)%>
                  <%= submit_tag I18n.t('save'), :class => 'btn btn-primary' %>
                <% end %>
                <button class="btn btn-secondary" data-dismiss="modal" aria-hidden="true"><%= I18n.t(:close) %></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
</section>

<script>

//$(".modal").css("width", "auto");
//$(".modal .modal-body").css("height", "auto");
//$(".modal .modal-body").css("width", "auto");
//$(".modal .modal-body").css("max-height", "900px");

    // Update the view_widget show_min_max attribute according to the selected widget_type
    var delete_min_max_on_widget_type = [ "line_chart", "bar_chart", "area_chart", "pie_chart", "timeline", "stacked_bar_chart", "histogram_effort_per_phase", "pie_chart_effort_per_phase", "histogram_cost_per_phase",
        "pie_chart_cost_per_phase", "stacked_bar_chart_effort_per_phases_profiles",  "stacked_bar_chart_cost_per_phases_profiles"]

    var widget_type = $("#views_widget_widget_type").val();
    if (widget_type == "text"){
        $('#views_widget_show_min_max').removeAttr('disabled');
    }
    else {
        $('#views_widget_show_min_max').attr('checked', false);
        $('#views_widget_show_min_max').attr('disabled','disabled');
        $("#views_widget_widget_type").value = 0;
    }


    // Update the view_widget attribute according to the selected module
    $("#views_widget_module_project_id").change(function() {
        if ($(this).val() !== ""){
            return $.ajax({
                url: "/update_widget_module_project_data",
                method: "GET",
                data: "module_project_id=" + $(this).val()
            });
        }
    });

    // Update the view_widget attribute according to the selected module
    $(".module_project_variables").change(function() {
        if ($(this).val() !== ""){
            return $.ajax({
                url: "/update_widget_module_project_data",
                method: "GET",
                data: "module_project_id=" + $(this).val() + "&view_widget_id=" + $(this).attr("view_widget_id") + "&letter=" + $(this).attr("letter")
            });
        }
    });

    $("#views_widget_widget_type").change(function() {
        var widget_type = $(this).val();
        if (widget_type == "text"){
            $('#views_widget_show_min_max').removeAttr('disabled');
        }
        else {
            $('#views_widget_show_min_max').attr('checked', false);
            $('#views_widget_show_min_max').attr('disabled','disabled');
            $("#views_widget_widget_type").value = 0;
        }
    });


    //manage the label widget
    $("#views_widget_is_label_widget").change(function(){
        if($(this).is(':checked')){
            //alert(1);
            //$("#new_views_widget").closest("tr").find(":input.inline_attr").attr("disabled", 'disabled');
            $("form#new_views_widget select.inline_attr, input:checkbox.inline_attr ").attr("disabled", 'disabled');
        } else{
            //alert(0);
            $("form#new_views_widget select.inline_attr, input:checkbox.inline_attr ").removeAttr('disabled');
        }
    });

    $("#views_widget_color").spectrum({
        showPaletteOnly: true,
        showPalette:true,
        hideAfterPaletteSelect:true,
        showInitial: true,
        preferredFormat: "hex",
        replacerClassName: 'mycolorpicker',
        //color: 'blanchedalmond',
        <% if @views_widget.new_record? %>
        color: 'blanchedalmond',
        <% end %>

        palette: [
            ['#E9ABBE', '#AA8AB8', "#FFD8BB", '#DAD5DC', '#E5D4DA'],
            ['#F3CFDA', '#E8B189', '#F4EBEE', '#D3CCC6', '#BDB1B5'],
            ['#D5DEBC', '#EAE4C6', '#839B94', '#E1F7A6', '#89CCB8'],
            ['#FFFFFF', '#B7D2FC', '#6CA5FF', '#B576AD', '#CEDEF6']
        ]
    });

    $('.sp-preview').css('width', '21rem');

</script>