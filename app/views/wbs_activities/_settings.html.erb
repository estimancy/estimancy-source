<h4>
  <strong>
    <%= I18n.t(:wbs_activities) %>
  </strong>
</h4>

<% effort = PeAttribute.find_by_alias("effort") %>   <!-- Retained effort -->
<% theoretical_effort =  PeAttribute.find_by_alias("theoretical_effort") %>
<% ratio = PeAttribute.find_by_alias("ratio") %>

<% cev = EstimationValue.where(:pe_attribute_id => effort.id,
                               :module_project_id => current_module_project.id,
                               :in_out => "input").first unless effort.nil? %>
<% cev_output = EstimationValue.where(:pe_attribute_id => effort.id,
                                      :module_project_id => current_module_project.id,
                                      :in_out => "output").first unless effort.nil? %>

<% theorical_cev_input = EstimationValue.where(:pe_attribute_id => theoretical_effort.id,
                               :module_project_id => current_module_project.id,
                               :in_out => "input").first unless theoretical_effort.nil? %>

<% theorical_cev_output = EstimationValue.where(:pe_attribute_id => theoretical_effort.id,
                                      :module_project_id => current_module_project.id,
                                      :in_out => "output").first unless theoretical_effort.nil? %>

<% ratio_output = EstimationValue.where(:pe_attribute_id => ratio.id,
                                      :module_project_id => current_module_project.id,
                                      :in_out => "output").first unless ratio.nil? %>

<% pev_save = EstimationValue.where(:pe_attribute_id => effort.id,
                               :module_project_id => current_module_project.previous.first,
                               :in_out => "output").first unless effort.nil? %>

<% possible_module_projects = current_module_project.possible_previous_mp_for_attribute(effort) %>
<% pev = EstimationValue.where(:pe_attribute_id => effort.id,
                               :module_project_id => possible_module_projects.last,
                               :in_out => "output").first unless effort.nil? %>

<% component_id = current_component.id %>
<% organization = @project.organization %>
<% wai = WbsActivityInput.where(module_project_id: current_module_project.id, wbs_activity_id: current_module_project.wbs_activity_id, pbs_project_element_id: current_component.id)
                                .first_or_create(module_project_id: current_module_project.id, pbs_project_element_id: current_component.id,
                                                 wbs_activity_id: current_module_project.wbs_activity_id, wbs_activity_ratio_id: @wbs_activity_ratio.id) %>

<% selected_ratio = wai.wbs_activity_ratio.nil? ? @wbs_activity_ratio : wai.wbs_activity_ratio %>

<% coeff = current_module_project.wbs_activity.effort_unit_coefficient.nil? ? 1 : current_module_project.wbs_activity.effort_unit_coefficient %>

<% if cev.nil? %>
    <% v_low = nil %>
    <% v_ml = nil %>
    <% v_high = nil %>

<% else %>
    <% if cev.string_data_low[component_id].blank? %>
      <% v_low = pev.nil? ? nil : (pev.string_data_low[component_id].to_f / coeff) %>
    <% else %>
      <% v_low = cev.nil? ? nil : (cev.string_data_low[component_id].to_f / coeff) %>
    <% end %>

    <% if cev.string_data_most_likely[component_id].blank? %>
      <% v_ml = pev.nil? ? nil : (pev.string_data_most_likely[component_id].to_f / coeff) %>
    <% else %>
      <% v_ml = cev.nil? ? nil : (cev.string_data_most_likely[component_id].to_f / coeff) %>
    <% end %>

    <% if cev.string_data_low[component_id].blank? %>
      <% v_high = pev.nil? ? nil : (pev.string_data_high[component_id].to_f / coeff) %>
    <% else %>
      <% v_high = cev.nil? ? nil : (cev.string_data_high[component_id].to_f / coeff) %>
    <% end %>
<% end %>

<%= form_tag save_effort_breakdown_path do %>

  <table class="table table-bordered">
    <tr>
      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <th>Effort (L)</th>
      <% end %>
      <th>Effort (M)</th>
      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <th>Effort (H)</th>
      <% end %>
      <th><%= I18n.t(:change_ratio) %></th>
      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <th>Effort total (L)</th>
      <% end %>

      <th>Effort total calculé (M)</th>
      <th>Effort total Retenu (M)</th>

      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <th>Effort total (H)</th>
      <% end %>
      <th>Ratio global</th>
      <th><%= I18n.t(:comment) %></th>
    </tr>
    <tr>

      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <% if (!current_module_project.wbs_activity.enabled_input || cannot?(:alter_estimation_plan, @project)) %>
          <td>
            <%= hidden_field_tag "values[low]", v_low %>
            <%= text_field_tag "", convert_with_precision(v_low, user_number_precision, true), disabled: true %>
          </td>
        <% else %>
          <td><%= number_field_tag "values[low]", v_low, step: "any", style: "width: 100px;" %></td>
        <% end %>
      <% end %>

      <% if (!current_module_project.wbs_activity.enabled_input || cannot?(:alter_estimation_plan, @project)) %>
        <td>
          <%= hidden_field_tag "values[most_likely]", v_ml %>
          <%= text_field_tag "", convert_with_precision(v_ml, user_number_precision, true), disabled: true %>
        </td>
      <% else %>
        <td><%= number_field_tag "values[most_likely]", v_ml, step: "any", style: "width: 100px;" %></td>
      <% end %>


      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <% if (!current_module_project.wbs_activity.enabled_input || cannot?(:alter_estimation_plan, @project)) %>
          <td>
            <%= hidden_field_tag "values[high]", v_high %>
            <%= text_field_tag "", convert_with_precision(v_high, user_number_precision, true), disabled: true %>
          </td>
        <% else %>
          <td><%= number_field_tag "values[high]", v_high, step: "any", style: "width: 100px;" %></td>
        <% end %>
      <% end %>

      <td>
        <%= select_tag "ratio",
                       options_for_select(current_module_project.wbs_activity.wbs_activity_ratios.map{|i| [i.name, i.id]},
                                          selected: wai.wbs_activity_ratio_id),
                       readonly: cannot?(:execute_estimation_plan, @project) %>
      </td>

      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <td>
          <% begin %>
            <%= convert_with_precision(cev_output.string_data_low[component_id][current_module_project.wbs_activity.root_element.id].to_f / coeff, user_number_precision, true) %>
          <% rescue %>
            -
          <% end %>
        </td>
      <% end %>


      <!-- Effort Theorique calculé -->
      <td>
        <strong>
          <% begin %>
              <%= convert_with_precision(theorical_cev_output.string_data_most_likely[component_id][current_module_project.wbs_activity.root_element.id].to_f / coeff, user_number_precision, true) %>
          <% rescue %>
              -
          <% end %>
        </strong>
      </td>

      <!-- Effort Retenu -->
      <td>
        <strong>
          <% begin %>
            <span id="retained_modified_effort"><%= convert_with_precision(cev_output.string_data_most_likely[component_id][current_module_project.wbs_activity.root_element.id].to_f / coeff, user_number_precision, true) %></span>
          <% rescue %>
            -
          <% end %>
        </strong>
      </td>


      <% if current_module_project.wbs_activity.three_points_estimation? %>
        <td>
          <strong>
            <% begin %>
              <%= convert_with_precision(cev_output.string_data_high[component_id][current_module_project.wbs_activity.root_element.id].to_f / coeff, user_number_precision, true) %>
            <% rescue %>
              -
            <% end %>
          </strong>
        </td>
      <% end %>

      <td>
        <strong>
          <span id="modified_global_ratio"><%= convert_with_precision(ratio_output.string_data_probable[component_id].to_f, user_number_precision, true) %></span>
        </strong>
      </td>

      <td>
        <span class="pull-left" >
          <%= link_to (wai.comment.nil? || wai.comment.blank?) ? '----' : wai.comment.truncate(25), "#", title: wai.comment, :"data-toggle" => "modal", :"data-target" => "#comment#{wai.id}", :"data-backdrop" => "static"  %>
        </span>
        <div class="modal fade" id="comment<%= wai.id %>" tabindex="-1" role="dialog" aria-labelledby="comment_label<%= wai.id %>" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="comment_label<%= wai.id %>">
                  <b>
                    <%= wai.wbs_activity.nil? ? '' : wai.wbs_activity.name %>
                  </b>
                </h4>
              </div>
              <div class="modal-body">
                <%= text_area_tag "comment[#{wai.id}]", wai.comment, class: "attribute_note_area" %>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" ><%= I18n.t(:close) %></button>
                <% if can?(:execute_estimation_plan, @project) %>
                    <button type="submit" class="btn btn-default"><%= I18n.t(:save) %></button>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </table>

  <% if can?(:execute_estimation_plan, @project) %>
    <%= submit_tag I18n.t(:calculate_save), class: "pull-right btn btn-mini" %>
  <% end %>

<% end %>


<!-- Ajout des valeurs des Ratios -->
<div id="module_project_ratio_elements">
  <%= form_tag update_effort_breakdown_retained_values_path do %>

    <div id="module_project_ratio_section">
        <%#= render :partial => 'wbs_activities/dashbord_wbs_activity_ratio_elements',
                   :object => [@wbs_activity_ratio_elements, @wbs_activity_ratio],
                   locals: { wbs_activity_ratio: selected_ratio, wai: wai, effort_unit_coeff: coeff, project_organization: organization } %>

      <%= render :partial => 'wbs_activities/dashbord_wbs_activity_ratio_elements_with_formula',
                 :object => [@wbs_activity_ratio_elements, @wbs_activity_ratio],
                 locals: { wbs_activity_ratio: selected_ratio, wai: wai, effort_unit_coeff: coeff, project_organization: organization } %>
    </div>

    <% if can?(:execute_estimation_plan, @project) %>
      <%= submit_tag I18n.t(:save_modifications), class: "pull-right btn btn-mini" %>
    <% end %>
  <% end %>
</div>
<!-- Fin Ajout des valeurs des Ratios -->


<%
   pbs_project_element = current_component
   wbs_activity = current_module_project.wbs_activity
   module_project = current_module_project
   wai = WbsActivityInput.where(wbs_activity_id: wbs_activity, module_project_id: module_project.id).first
   probable_est_value = cev_output.send("string_data_probable")
   pbs_probable_est_value = probable_est_value[pbs_project_element.id]

   begin
     ratio_reference = wai.wbs_activity_ratio
   rescue
     ratio_reference = wbs_activity.wbs_activity_ratios.first
   end

   project_organization = module_project.project.organization
   wbs_activity_elements = wbs_activity.wbs_activity_elements

   # We don't want to show element with nil ratio value
   project_organization_profiles = []
   ratio_profiles_with_nil_ratio = []
   wbs_activity_ratio_profiles = []
   unless ratio_reference.nil?
     ratio_reference.wbs_activity_ratio_elements.each do |ratio_elt|
       ratio_profiles_with_nil_ratio << ratio_elt.wbs_activity_ratio_profiles
     end
     # Reject all RatioProfile with nil ratio_value
     wbs_activity_ratio_profiles = ratio_profiles_with_nil_ratio.flatten.reject{|i| i.ratio_value.nil? }
   end
   wbs_activity_ratio_profiles.each do |ratio_profile|
     project_organization_profiles << ratio_profile.organization_profile
   end
   project_organization_profiles = project_organization_profiles.uniq
%>

<div class="modal fade" id="modal_comments" tabindex="-1" role="dialog" aria-labelledby="modal_comments_label" aria-hidden="true" backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content" id="modal_comments_content">
    </div>
  </div>
</div>

<div class="modal fade" id="form_modal" tabindex="-1" role="dialog" aria-labelledby="form_modal_label" aria-hidden="true" backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content" id="form_modal_content">
    </div>
  </div>
</div>


<!--<div class="row-fluid">-->
  <!--<div class="span12">-->
    <!--<%# raw(render :partial => 'views_widgets/effort_by_phases_profiles', :locals => {  project_wbs_activity_elements: wbs_activity.wbs_activity_elements,-->
                                                                                        <!--pe_attribute: cev.pe_attribute,-->
                                                                                        <!--module_project: module_project,-->
                                                                                        <!--project_organization_profiles: project_organization_profiles,-->
                                                                                        <!--estimation_pbs_probable_results: pbs_probable_est_value,-->
                                                                                        <!--ratio_reference: ratio_reference } ) %>-->
  <!--</div>-->
<!--</div>-->

<!--<div class="row-fluid">-->
  <!--<div class="span12">-->
    <!--<%# raw(cev.nil? ? "#{ content_tag(:div, I18n.t(:notice_no_estimation_saved), :class => 'no_estimation_value')}" : display_effort_or_cost_per_phase(pbs_project_element, module_project, cev_output, nil)) %>-->
  <!--</div>-->
<!--</div>-->

<!--<div class="row-fluid">-->
  <!--<div class="span12">-->
    <!--<%# raw(render :partial => 'views_widgets/effort_by_phases', :locals => { pbs_project_element: pbs_project_element,-->
                                                                              <!--module_project: module_project,-->
                                                                              <!--cev_output: cev_output } ) %>-->
  <!--</div>-->
<!--</div>-->