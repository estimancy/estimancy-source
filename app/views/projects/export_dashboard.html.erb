<%= wicked_pdf_stylesheet_link_tag "application", media: "all", "data-turbolinks-track" => true %>

<div class="row-fluid">
  <div class="span2">
    <b>Nom de l'organisation</b>
  </div>
  <div class="span3">
    <%= @project.organization.name %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Numéro du devis</b>
  </div>
  <div class="span3">
    <%= @project.title %> <%= @project.version_number %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Nom de l'application</b>
  </div>
  <div class="span3">
    <%= @project.application %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Description</b>
  </div>
  <div class="span3">
    <%= @project.description %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Secteur de projets</b>
  </div>
  <div class="span3">
    <%= @project.project_area %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Acquisition</b>
  </div>
  <div class="span3">
    <%= @project.acquisition_category %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Platform Category</b>
  </div>
  <div class="span3">
    <%= @project.platform_category %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Date de démarrage</b>
  </div>
  <div class="span3">
    <%= @project.start_date %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Statut du devis</b>
  </div>
  <div class="span3">
    <%= @project.estimation_status %>
  </div>
</div>

<div class="row-fluid">
  <div class="span2">
    <b>Historique des changements de statuts</b>
  </div>
  <div class="span3">
    <%= @project.status_comment %>
  </div>
</div>

<%
   @module_projects.each do |module_project|

     if module_project.pemodule.alias == "guw"
       @guw_model = module_project.guw_model
       @unit_of_work_groups = ModuleProjectGuwUnitOfWorkGroup.where(organization_id: @current_organization.id,
                                                                    project_id: @project.id,
                                                                    module_project_id: module_project.id,
                                                                    pbs_project_element_id: @pbs_project_element.id).all

     elsif module_project.pemodule.alias == "effort_breakdown"
       @wbs_activity = module_project.wbs_activity
       @project_wbs_activity_elements = WbsActivityElement.sort_by_ancestry(@wbs_activity.wbs_activity_elements.arrange(:order => :position))
       @wbs_activity_ratio = module_project.get_wbs_activity_ratio(@pbs_project_element.id)

       if @wbs_activity_ratio.nil?
         unless params[:ratio].nil?
           @wbs_activity_ratio = WbsActivityRatio.find(params[:ratio])
         end
       end

       unless @wbs_activity_ratio.nil?
         ratio_elements = @wbs_activity_ratio.wbs_activity_ratio_elements.joins(:wbs_activity_element).arrange(order: 'position')
         @wbs_activity_ratio_elements = WbsActivityRatioElement.sort_by_ancestry(ratio_elements)

         # Module_project Ratio elements
         @module_project_ratio_elements = module_project.get_module_project_ratio_elements(@wbs_activity_ratio, @pbs_project_element)

         # Module Project Ratio Variables
         @module_project_ratio_variables = module_project.get_module_project_ratio_variables(@wbs_activity_ratio, @pbs_project_element)
       end
     else
       # other
     end
   end
%>

<hr>
<% @module_projects.each do |module_project| %>
  <% if module_project.pemodule.alias == "effort_breakdown" %>
    <h2>
      <%= @wbs_activity.name %>
    </h2>
    <table class="table">
      <tr>
        <th>Nom</th>
        <th>Effort Théorique</th>
        <th>Cout Théorique</th>
        <th>Effort Retenu</th>
        <th>Cout Retenu</th>
        <th>Commentaire</th>
      </tr>

      <% @wbs_activity_ratio = @wbs_activity.wbs_activity_ratios.first %>
      <% @module_project_ratio_elements = module_project.get_module_project_ratio_elements(@wbs_activity_ratio, current_component) %>

      <% @wbs_activity.wbs_activity_elements.each do |wbs_activity_element| %>
        <% mp_ratio_element = @module_project_ratio_elements.select { |mp_ratio_elt| mp_ratio_elt.wbs_activity_element_id == wbs_activity_element.id }.first %>
        <tr>
          <td>
            <%= wbs_activity_element.name %>
          </td>
          <td>
            <%= mp_ratio_element.retained_effort_probable %>
          </td>
          <td>
            <%= mp_ratio_element.retained_cost_probable %>
          </td>
          <td>
            <%= mp_ratio_element.theoretical_effort_probable %>
          </td>
          <td>
            <%= mp_ratio_element.theoretical_cost_probable %>
          </td>
          <td>
            <%= mp_ratio_element.comments %>
          </td>
        </tr>
      <% end %>
    </table>

    <% view_widgets = ViewsWidget.where(module_project_id: module_project.id).all %>
    <div class="row-fluid">
      <% view_widgets.each do |view_widget| %>
        <div class="span3">
          <h4><%= view_widget.name %></h4>
          <% unless view_widget.estimation_value.nil? %>
            <p>
              <%= view_widget.estimation_value.string_data_probable[current_component.id][@wbs_activity.root_element.id][:value] %>
            </p>
          <% end %>
        </div>
      <% end %>
    </div>

    <hr>


  <% elsif module_project.pemodule.alias == "guw" %>
    <h2>
      <%= @guw_model.name %>
    </h2>
    <% unless @unit_of_work_groups.nil? %>
      <% @guw_types = @guw_model.guw_types.includes(:guw_complexities) %>
      <% @unit_of_work_groups.each do |uowg| %>
        <h3>
          <%= uowg.name %>
        </h3>
        <table class="table table-bordered">
          <tr>
            <th>Nom</th>
            <th>Type</th>
            <% @guw_model.orders.sort_by { |k, v| v.to_f }.each do |i| %>
              <% unless i[1].blank? %>
                <% if Guw::GuwCoefficient.where(name: i[0]).first.class == Guw::GuwCoefficient %>
                  <% guw_coefficient = Guw::GuwCoefficient.where(name: i[0], guw_model_id: @guw_model.id, deported: false).first %>
                  <% unless guw_coefficient.nil? %>
                    <th>
                      <%= i[0] %>
                    </th>
                  <% end %>
                <% elsif i[0] == "Coefficient" %>
                  <% unless @guw_model.guw_coefficients.where(deported: true).map(&:id).empty? %>
                    <th>
                      <%= i[0] %>
                    </th>
                  <% end %>
                <% elsif i[0] == "Critères" %>

                <% elsif i[0] == "Coeff. de Complexité" %>
                  <% if i[1].blank? %>
                    <th></th>
                  <% else %>
                    <th>
                      <% if @guw_types.map{|i| i.allow_criteria }.flatten.include?(true) %>
                        Coeff. de complexité
                      <% else %>
                        Complexité
                      <% end %>
                    </th>
                  <% end %>
                <% else %>
                  <th>
                    <%= i[0] %>
                  </th>
                <% end %>
              <% end %>
            <% end %>
          </tr>

          <% uowg.guw_unit_of_works.each do |uow| %>
            <tr>
              <td>
                <%= uow.name %>
              </td>
              <td>
                <%= uow.guw_type %>
              </td>

              <% @guw_model.orders.sort_by { |k, v| v.to_f }.each do |i| %>
                <% unless i[1].blank? %>
                  <% if i[0] == "Coeff. de Complexité" %>
                    <td>
                      <%= uow.intermediate_percent %>
                    </td>
                  <% elsif Guw::GuwCoefficient.where(name: i[0], guw_model_id: @guw_model.id).first.class == Guw::GuwCoefficient %>
                    <% @guw_coefficient = Guw::GuwCoefficient.where(name: i[0], guw_model_id: @guw_model.id).first %>
                    <% if @guw_coefficient.coefficient_type == "Pourcentage" || @guw_coefficient.coefficient_type == "Coefficient" %>
                      <% ceuw = Guw::GuwCoefficientElementUnitOfWork.where(guw_unit_of_work_id: uow.id,
                                                                           guw_coefficient_id: @guw_coefficient.id,
                                                                           guw_coefficient_element_id: nil).last %>
                      <td>
                        <%= ceuw.percent %>
                      </td>
                    <% else %>
                      <% ceuw = Guw::GuwCoefficientElementUnitOfWork.where(guw_unit_of_work_id: uow.id,
                                                                           guw_coefficient_id: @guw_coefficient.id).last %>
                      <td>
                        <%= ceuw.guw_coefficient_element.name %>
                      </td>
                    <% end %>

                  <% elsif Guw::GuwOutput.where(name: i[0], guw_model_id: @guw_model.id).first.class == Guw::GuwOutput %>
                    <% go = Guw::GuwOutput.where(name: i[0], guw_model_id: @guw_model.id).first %>
                    <td>
                      <%= uow.ajusted_size["#{go.id}"] %>
                    </td>
                  <% else %>

                  <% end %>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </table>

        <% view_widgets = ViewsWidget.where(module_project_id: module_project.id).all %>
        <div class="row-fluid">
          <% view_widgets.each do |view_widget| %>
            <div class="span3">
              <h4><%= view_widget.name %></h4>
              <% unless view_widget.estimation_value.nil? %>
                <% if view_widget.estimation_value.string_data_probable.is_a?(Float) %>
                  <p>
                    <%= view_widget.estimation_value.string_data_probable %>
                  </p>
                <% else %>
                  <p>
                    <%= view_widget.estimation_value.string_data_probable[current_component.id] %>
                  </p>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>

        <hr>

      <% end %>
    <% end %>

  <% end %>
<% end %>