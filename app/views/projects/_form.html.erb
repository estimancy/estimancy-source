<br>
<br>
<%= simple_form_for(@project) do |f| %>

  <%= hidden_field_tag :project_id, @project.id %>
  <% can_alter_model = can?(:manage_estimation_models, Project) %>

  <div class="card card-content-bloc estimation-edition">
    <div class="card-body">

      <div class="edition-bloc-left">
        <div class="edition-bloc-title">
          Estimation
        </div>
      </div>

      <div class="edition-bloc-form">

        <div class="edition-bloc-comment">
          <img src="/assets/speech-bubble.svg">
          <span class="edition-bloc-nbcomment">2</span>
        </div>

        <div class="form-row">
          <div class="col-6">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <%= f.input :title,
                          :label => false,
                          :disabled => !(can?(:alter_estimation_name, @project) || can_alter_model),
                          :input_html => { :class => 'mdl-textfield__input', :autofocus => (controller.action_name == 'new') } %>

              <label class="mdl-textfield__label" for="name">Nom</label>
            </div>
          </div>
          <div class="col-2">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <%= f.input :version_number, :input_html => { :class => 'mdl-textfield__input' }, :disabled => true, label: false %>
              <label class="mdl-textfield__label" for="version">Version</label>
              <span class="mdl-textfield__error">Input is not a number!</span>
            </div>
          </div>
          <div class="col-4">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select">
              <input type="text" value="" class="mdl-textfield__input" id="status" readonly>
              <input type="hidden" value="" name="status">
              <i class="mdl-icon-toggle__label material-icons">arrow_drop_down</i>
              <label for="status" class="mdl-textfield__label">Statut</label>
              <ul for="status" class="mdl-menu mdl-menu--bottom-left mdl-js-menu">
                <li class="mdl-menu__item" data-val="encours">En cours</li>
                <li class="mdl-menu__item" data-val="relecture">En relecture</li>
                <li class="mdl-menu__item" data-val="controle">Contrôle</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="col-12">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <%= f.input :business_need, :label => false, :disabled => !(can?(:alter_request_number, @project) || can_alter_model), :input_html => { :class => 'mdl-textfield__input' } %>
              <label class="mdl-textfield__label" for="need">Besoin métier</label>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="col-12">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <%= f.input :request_number, :label => false, :disabled => !(can?(:alter_request_number, @project) || can_alter_model), :input_html => { :class => 'mdl-textfield__input' } %>
              <label class="mdl-textfield__label" for="number">N° de la demande</label>
              <span class="mdl-textfield__error">Merci de saisir un nombre</span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="col-12">
            <% if @project.is_model == true %>
              <% apps = @project.applications %>
              <% if @current_organization.applications.empty? and apps.empty? %>
                <%= f.input :application_name,
                            :label => I18n.t(:label_product_name),
                            :disabled => !((can_alter_estimation?(@project) && can?(:alter_product_name, @project)) || can_alter_model) ,
                            :input_html => { :class => '' } %>
              <% else %>
                <%= f.association :applications,
                                  as: :select,
                                  collection: @current_organization.applications.active,
                                  :label => I18n.t(:label_product_name),
                                  :input_html => { :class => '' },
                                  include_blank: true,
                                  :disabled => !((can_alter_estimation?(@project) && can?(:alter_product_name, @project)) || can_alter_model) %>
              <% end %>
            <% end %>
          </div>
        </div>

        <% if @project.new_record? %>
          <%= f.input :is_model, :as => :hidden, input_html: { value: @is_model } %>
        <% end %>

        <% if @project.is_model || @is_model %>
          <%= f.input :use_automatic_quotation_number, :label => "#{I18n.t 'use_automatic_quotation_number'}", :disabled => !(can?(:alter_estimation_name, @project) || can_alter_model), :input_html => { :class => 'input-xxlarge' } %>
          <%= f.input :allow_export_pdf, :label => I18n.t("Autoriser l'export PDF"), :disabled => !(can?(:alter_estimation_name, @project) || can_alter_model), :input_html => { :class => 'input-xxlarge' } %>
        <% end %>

        <%= f.input :demand_id, as: :hidden, :input_html => { :value => params[:demand_id] } %>

        <div class="form-row">
          <div class="col-8">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty">
              <a href="#" class="" id="template">
                <% if !@project.original_model_id.nil? %>
                  <% if can_show_estimation?(@project.original_model) %>
                    <% unless @project.original_model.nil? %>
                      <%= link_to(@project.original_model, dashboard_path(@project.original_model)) %>

                    <% end %>
                  <% else %>
                    <%= @project.original_model %>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </a>
              <label for="template" class="mdl-textfield__label active">Modèle d’origine</label>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="col-8">
            <%= f.input :private, disabled: !(can?(:alter_private_estimation_setup, @project) || can_alter_model), label: raw("&nbsp; Privée"), class: "custom-control-input" %>
          </div>
        </div>
        <div class="form-row">
          <div class="col-12">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <textarea class="mdl-textfield__input" type="text" rows="3" id="description"></textarea>
              <label class="mdl-textfield__label" for="description">Description</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <br>
  <br>

  <div class="card card-content-bloc estimation-edition">
    <div class="card-body">

      <div class="edition-bloc-left">
        <div class="edition-bloc-title">
          Projet
        </div>
      </div>

      <div class="edition-bloc-content">
        <div class="edition-bloc-form">
          <div class="form-row">
            <div class="col-12">
              <div class="select-estimancy">
                <label for="platformCategory" class="label-estimancy"><%= I18n.t 'project_area' %></label>
                <%= f.association :project_area,
                                  :label => false,
                                  :as => :select,
                                  :collection => @project_areas,
                                  :input_html => { :class => 'form-control' },
                                  :disabled => !((can_alter_estimation?(@project) && can?(:alter_project_areas, @project)) || can_alter_model) %>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="col-12">
              <div class="select-estimancy">
                <label for="platformCategory" class="label-estimancy"><%= I18n.t 'acquisition_category' %></label>
                <%= f.association :acquisition_category,
                                  :label => false,
                                  :as => :select,
                                  :collection => @acquisition_categories,
                                  :input_html => {:class => 'form-control'},
                                  :disabled => !((can_alter_estimation?(@project) && can?(:alter_acquisition_categories, @project)) || can_alter_model) %>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="col-12">
              <div class="select-estimancy">
                <label for="platformCategory" class="label-estimancy"><%= I18n.t 'platform_category' %></label>
                <%= f.association :platform_category,
                                  :label => false,
                                  :as => :select,
                                  :collection => @platform_categories,
                                  :input_html => {:class => 'form-control'},
                                  :disabled => !((can_alter_estimation?(@project) && can?(:alter_platform_categories, @project)) || can_alter_model) %>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="col-12">
              <div class="select-estimancy">
                <label for="platformCategory" class="label-estimancy"><%= I18n.t 'project_category' %></label>
                <%= f.association :project_category,
                                  :label => false,
                                  :as => :select,
                                  :collection => @project_categories,
                                  :input_html => {:class => 'form-control'},
                                  :disabled => !((can_alter_estimation?(@project) && can?(:alter_project_categories, @project)) || can_alter_model) %>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="col-12">
              <div class="select-estimancy">
                <label for="platformCategory" class="label-estimancy"><%= I18n.t 'provider' %></label>
                <%= f.association :provider,
                                  :label => false,
                                  :as => :select,
                                  :collection => @providers,
                                  :input_html => {:class => 'form-control'},
                                  :disabled => !((can_alter_estimation?(@project) && can?(:alter_providers, @project))  || can_alter_model) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <br>
  <br>

  <div class="card card-content-bloc estimation-edition">
    <div class="card-body">

      <div class="edition-bloc-left">
        <div class="edition-bloc-title">
          <%= @project.is_model ? I18n.t(:label_model_group_security_resume) : I18n.t(:label_group_security_resume) %>
        </div>
      </div>


      <div class="edition-bloc-content">
        <table class="table access-table">
          <thead>
            <tr>
              <th><%= I18n.t(:group_name)%></th>
              <% @organization.project_security_levels.each do |prj_level| %>
                <th><span class="attribute_tooltip" title='<%= display_security_level_description(prj_level) %>'><%= prj_level.name %></span></th>
              <% end %>
            </tr>
          </thead>

          <tbody>
            <% @organization.groups.each do |group| %>
              <tr>
                <td>
                  <%= group.name %>
                  <% @organization.project_security_levels.each do |prj_level| %>
                    <%
                      ps = ProjectSecurity.where(group_id: group.id,
                                                 project_id: @project.id,
                                                 project_security_level_id: prj_level.id,
                                                 is_model_permission: false,
                                                 is_estimation_permission: true).first
                    %>
                  <td>
                    <div class="custom-control custom-checkbox">
                      <%= check_box_tag("group_securities[#{prj_level.id}][#{group.id}]", group.name, !ps.nil?, label: false, class: "custom-control-input") %>
                      <label class="custom-control-label" for="group_securities_<%= prj_level.id %>_<%= group.id %>"></label>
                    </div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
          <%= render :partial => 'layouts/footer_table' %>
        </table>

          <% if (@project.is_model && can?(:manage_estimation_models, Project)) || (!@project.is_model && can_modify_estimation?(@project)) %>
            <%= submit_tag I18n.t('save'), :name => "model_group_security_levels", :class => 'btn btn-primary' %>
            <%= submit_tag I18n.t('apply'), :name => "model_group_security_levels", :class => 'btn btn-primary', :anchor_value => params[:anchor_value] %>
          <% end %>

          <% if @project.is_model %>
            <%= link_to I18n.t('back'), projects_from_path(organization_id: @organization.id), :class => 'btn btn-secondary' %>
          <% else %>
            <%= link_to I18n.t('back'), organization_estimations_path(@organization), :class => 'btn btn-secondary' %>
          <% end %>

      </div>
    </div>
  </div>

  <br>
  <br>

<% end %>