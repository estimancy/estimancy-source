<div class="d-flex align-items-center mt-4">
  <div style="flex: 1">
    <h1><%= I18n.t("projects_list") %></h1>
  </div>
</div>

<div class="mb-5">
  <div class="estimation-list">
    <div class="estimation-list-filter">
      <span><%= @projects.count %> <%= I18n.t(:elements) %></span>
      <span>
        <a href="#"><%= I18n.t(:display_archives) %></a>
      </span>
    </div>
    <table class="estimation-table">
      <thead>
      <tr>
        <% selected_inline_columns = update_selected_inline_columns(Project) %>
        <% selected_inline_columns.each do |column| %>
          <%= column_header(column) %>
        <% end %>
        <th></th>
      </tr>
      </thead>

      <tbody>
      <% @projects.each_with_index do |project, index| %>
        <tr>

          <% selected_inline_columns.each do |column| %>
            <%= column_content(@pfs, column, project, @fields_coefficients) %>
          <% end %>

          <% @project_module_projects = project.module_projects %>
          <td class="estimation-table-overview-cell">
            <div class="tools">
              <a href="<%= edit_project_path(project) %>"><i class="material-icons">edit</i></a>
              <div class="dropdown">
                <button class="dropdown-toggle" type="button" id="dropdownToolsButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">more_vert</i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownToolsButton">
                  <a class="dropdown-item" href="<%= export_dashboard_path(format: "pdf", project_id: project.id) %>"><i class="material-icons">picture_as_pdf</i>Exporter en PDF</a>
                  <% if can? :copy_project, project %>
                    <a class="dropdown-item" href="<%= main_app.duplicate_path(project, organization_id: @organization, action_name: "duplication") %>" method="POST"><i class="material-icons">file_copy</i>Dupliquer l'estimation</a>
                  <% end %>
                  <% if can?(:commit_project, project) %>
                    <a class="dropdown-item" data-remote="true" href="<%= set_checkout_version_path(:project_id => project.id) %>"><i class="material-icons">call_split</i>Créer une nouvelle version</a>
                  <% end %>
                  <div class="dropdown-divider"></div>
                  <% if (can? :delete_project, project) || (can? :manage, project) %>
                    <% if can_delete_estimation?(project) %>
                      <a class="dropdown-item" href="<%= confirm_deletion_path(project_id: project.id) %>"><i class="material-icons">delete</i>Supprimer</a>
                    <% end %>
                  <% end %>

                </div>
              </div>
            </div>


            <div class="card estimation-overview">
              <div class="card-body" style="width: 568.5px; min-height: 900px;">
                <a href="#" class="close-button"><i class="material-icons">close</i></a>
                <div class="d-flex justify-content-between">
                  <div class="estimation-overview-title" style="flex: 1">
                    <h5 class="estimation-overview-title">
                      <%= project.title %>
                    </h5>
                  </div>
                  <a href="<%= dashboard_path(project) %>">
                    <button type="button" class="btn btn-secondary">
                      Voir le détail
                    </button>
                  </a>
                </div>
                <h6 class="estimation-overview-author">
                  <%= project.creator %>
                </h6>
                <p class="estimation-overview-text mb-3">
                  <%= raw(project.description) %>
                </p>

                <% @widgets = {} %>
                <% @project_module_projects = project.module_projects %>

                <% project.views_widgets.each do |view_widget| %>
                  <% if view_widget.is_label_widget? %>
                    <% view_widget_data = get_label_widget_data(view_widget.id) %>
                    <% @widgets[view_widget.name] = view_widget_data[:string_data_probable] %>
                  <% elsif view_widget.is_kpi_widget? %>
                    <% view_widget_data = get_kpi_value_without_unit(view_widget) %>
                    <% @widgets[view_widget.name] = view_widget_data %>
                  <% else %>
                    <% view_widget_data = new_get_view_widget_data(view_widget.module_project_id, view_widget.id) %>
                    <% if view_widget.widget_type == "text" %>
                      <% @widgets[view_widget.name] = view_widget_data %>
                    <% end %>
                  <% end %>
                <% end %>

                <div class="d-flex estimation-overview-quantity mb-5 row">
                  <% unless @widgets.keys.reverse[0..1].nil? %>
                    <% @widgets.keys.reverse[0..1].each do |k| %>
                      <% value = @widgets[k] %>
                      <% unless value.is_a?(Hash) %>
                        <div class="col">
                          <div class="card card-man-day">
                            <div class="card-body">
                              <span><%= k %></span>
                              <div class="quantity">
                                <span>
                                  <%= value.nil? ? '-' : value %>
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

                <div class="row estimation-overview-infos mb-3">
                  <% unless @widgets.keys.reverse[1..3].nil? %>
                    <% @widgets.keys.reverse.each do |k| %>
                      <% value = @widgets[k] %>
                      <% unless value.is_a?(Hash) %>
                        <div class="col">
                          <%= k %>
                          <div class="estimation-overview-info-number">
                            <span>
                              <%= value %>
                            </span>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

                <div class="row estimation-overview-infos mb-3">
                  <% unless @widgets.keys.reverse[3..5].nil? %>
                    <% @widgets.keys.reverse[3..5].each do |k| %>
                      <% value = @widgets[k] %>
                      <% unless value.is_a?(Hash) %>
                        <div class="col">
                          <%= k %>
                          <div class="estimation-overview-info-number">
                              <span>
                                <%= value %>
                              </span>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

                <div class="row estimation-overview-infos mb-3">
                  <% unless @widgets.keys.reverse[5..7].nil? %>
                    <% @widgets.keys.reverse[5..7].each do |k| %>
                      <% value = @widgets[k] %>
                      <% unless value.is_a?(Hash) %>
                        <div class="col">
                          <%= k %>
                          <div class="estimation-overview-info-number">
                            <span>
                              <%= value %>
                            </span>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

              </div>
            </div>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>
    // Quand l'utilisateur scroll, on passe l'overview en sticky si besoin
    window.onscroll = function() {setOverviewSticky()};

    function setOverviewSticky(pOverview) {
        var overview;
        if (pOverview) {
            overview = pOverview;
        } else {
            overview = $(".estimation-overview:visible");
        }
        var table = $(".estimation-table");
        var tableTop = table[0].offsetTop + 58;
        var tableBottom = table[0].offsetTop + table[0].offsetHeight;

        if(overview.length) {
            if (window.pageYOffset > tableTop && (window.pageYOffset + window.innerHeight) < tableBottom) {
                overview.removeClass('sticky-bottom').addClass("sticky");
                overview.children('.card-body').css("width", ((table.width() * 55 / 100) - 42) + "px");
                overview.children('.card-body').css("min-height", "900px");
            } else if(window.pageYOffset > tableTop) {
                if((overview.children('.card-body')[0].offsetHeight > tableBottom - window.pageYOffset)) {
                    overview.addClass("sticky").addClass("sticky-bottom");
                } else {
                    overview.removeClass('sticky-bottom').addClass("sticky")
                }
                overview.children('.card-body').css("width", ((table.width() * 55 / 100) - 42) + "px");
                overview.children('.card-body').css("min-height", "900px");
            } else {
                overview.removeClass("sticky").removeClass("sticky-bottom");
                // overview.children('.card-body').removeAttr("style");
            }
        }
    }

</script>




