<div class="d-flex align-items-center mt-4">
  <div style="flex: 1">
    <h1><%= I18n.t("projects_list") %></h1>
  </div>
  <a href="<%= projects_from_path(organization_id: @organization.id) %>">
    <button type="button" class="btn btn-primary">
      <%= I18n.t("create_project") %>
    </button>
  </a>
  <% unless "saas".in?(request.original_url) || "demo".in?(request.original_url) %>
    <%# link_to I18n.t(:extract_raw_data), raw_data_extraction_path(organization_id: @organization.id), :class => 'btn', method: 'post' %>
  <% end %>
</div>

<% if @current_user.quick_access %>
  <p>
    <span class="font-weight-bold"><%= I18n.t("quick_access") %></span> <%= I18n.t("to_the_latest_estimations_consulted") %>
  </p>

  <div class="mb-5">
    <div class="quickview-list">
        <% current_user.recent_projects.uniq.take(4).reverse.each do |project_id| %>
          <% project = Project.find(project_id) %>
          <% unless project.nil? %>
            <div class="card card-cliquable estimation-quickview w-25">
              <a href="<%= dashboard_path(project) %>">
                <div class="card-body">
                  <h5 class="estimation-quickview-title"><%= project.title %></h5>
                  <h6 class="estimation-quickview-status mb-2" style="color: <%= project.status_background_color %>;">
                    <%= project.estimation_status.name %>
                  </h6>
                  <div class="d-flex"><span class="estimation-quickview-date mb-2 "><%= project.start_date %></span><span class="estimation-quickview-version mb-2 "><%= project.version_number %></span></div>
                  <p class="estimation-quickview-text"><%= simple_format project.description %></p>

                  <% @data_widget_hash = {} %>
                  <% @project_module_projects = project.module_projects %>
                  <% @project_module_projects.each do |module_project| %>
                    <% module_project_view = module_project.view %>
                    <% unless module_project_view.nil? %>
                      <% module_project_view_widgets = module_project_view.views_widgets.order('position').all %>
                      <% module_project_view_widgets.each do |view_widget| %>
                        <% if module_project.pemodule.alias == Projestimate::Application::INITIALIZATION %>
                          <% view_widget_data = new_get_view_widget_data(view_widget.module_project_id, view_widget.id) %>
                          <% if view_widget.widget_type == "text" %>
                            <% @data_widget_hash[view_widget.name] = view_widget_data %>
                          <% end %>
                        <% else %>
                          <% view_widget_data = new_get_view_widget_data(module_project.id, view_widget.id) %>
                          <% @data_widget_hash[view_widget.name] = view_widget_data %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>

                  <div class="d-flex justify-content-between">
                    <% unless @data_widget_hash.keys.reverse[1..2].nil? %>
                      <% @data_widget_hash.keys.reverse[1..2].each do |k| %>
                        <% value = @data_widget_hash[k] %>
                        <% unless value.is_a?(Hash) %>
                          <span class="estimation-quickview-quantity">
                            <%= value.nil? ? '-' : value %>
                          </span>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </a>
            </div>
          <% end %>
        <% end %>

    </div>
  </div>
<% end %>

<div class="mb-5">
  <div class="estimation-list">
    <div class="estimation-list-filter">
      <span><%= @all_projects.count %> <%= I18n.t("elements") %></span>
      <span>
        <a href="#"><%= I18n.t("display_archives") %></a>
      </span>
    </div>
    <table class="estimation-table">
      <thead>
        <tr>
          <% selected_inline_columns = update_selected_inline_columns(Project) %>
          <% selected_inline_columns.each do |column| %>
            <%= column_header(column) %>
          <% end %>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <% @projects.each_with_index do |project, index| %>
          <tr>

            <% selected_inline_columns.each do |column| %>
              <%= column_content(@pfs, column, project, @fields_coefficients) %>
            <% end %>

            <% @project_module_projects = project.module_projects %>
            <td class="estimation-table-overview-cell">
              <div class="tools">
                <a href="<%= edit_project_path(project) %>"><i class="material-icons">edit</i></a>
                <div class="dropdown">
                  <button class="dropdown-toggle" type="button" id="dropdownToolsButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="material-icons">more_vert</i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownToolsButton">
                    <a class="dropdown-item" href="<%= export_dashboard_path(format: "pdf", project_id: project.id) %>"><i class="material-icons">picture_as_pdf</i><%= I18n.t("export_to_pdf") %></a>
                    <% if can? :copy_project, project %>
                      <a class="dropdown-item" href="<%= main_app.duplicate_path(project, organization_id: @organization, action_name: "duplication") %>" method="POST"><i class="material-icons">file_copy</i><%= I18n.t("duplicate_estimation") %></a>
                    <% end %>
                    <% if can?(:commit_project, project) %>
                      <a class="dropdown-item" data-remote="true" href="<%= set_checkout_version_path(:project_id => project.id) %>"><i class="material-icons">call_split</i><%= I18n.t("create_new_version") %></a>
                    <% end %>
                    <div class="dropdown-divider"></div>
                    <% if (can? :delete_project, project) || (can? :manage, project) %>
                      <% if can_delete_estimation?(project) %>
                        <a class="dropdown-item" href="<%= confirm_deletion_path(project_id: project.id) %>"><i class="material-icons">delete</i><%= I18n.t("delete") %></a>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>


              <div class="card estimation-overview">
                <div class="card-body" style="width: 568.5px; min-height: 900px;">
                  <a href="#" class="close-button"><i class="material-icons">close</i></a>
                  <div class="d-flex justify-content-between">
                    <div class="estimation-overview-title" style="flex: 1">
                      <h5 class="estimation-overview-title">
                        <%= project.title %>
                      </h5>
                    </div>
                    <a href="<%= dashboard_path(project) %>">
                      <button type="button" class="btn btn-secondary">
                        <%= I18n.t :see_the_detail  %>
                      </button>
                    </a>
                  </div>
                  <h6 class="estimation-overview-author">
                    <%= project.creator %>
                  </h6>
                  <p class="estimation-overview-text mb-3">
                    <%= raw(project.description) %>
                  </p>

                  <% @label_widget_hash = {} %>
                  <% @kpi_widget_hash = {} %>
                  <% @data_widget_hash = {} %>
                  <% @project_module_projects = project.module_projects %>

                  <% @project_module_projects.each do |module_project| %>
                    <% module_project_view = module_project.view %>
                    <% unless module_project_view.nil? %>
                      <% module_project_view_widgets = module_project_view.views_widgets.order('position').all %>
                      <% module_project_view_widgets.each do |view_widget| %>
                        <% if view_widget.is_label_widget? %>
                          <% view_widget_data = get_label_widget_data(view_widget.id) %>
                          <% @label_widget_hash[view_widget.name] = view_widget_data[:string_data_probable] %>
                        <% elsif view_widget.is_kpi_widget? %>
                          <% view_widget_data = get_kpi_value_without_unit(view_widget) %>
                          <% @kpi_widget_hash[view_widget.name] = view_widget_data %>
                        <% else %>
                          <% if module_project.pemodule.alias == Projestimate::Application::INITIALIZATION %>
                            <% view_widget_data = new_get_view_widget_data(view_widget.module_project_id, view_widget.id) %>
                            <% if view_widget.widget_type == "text" %>
                              <% @data_widget_hash[view_widget.name] = view_widget_data %>
                            <% end %>
                          <% else %>
                            <% view_widget_data = new_get_view_widget_data(module_project.id, view_widget.id) %>
                            <% @data_widget_hash[view_widget.name] = view_widget_data %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>

                  <div class="d-flex estimation-overview-quantity mb-5 row">
                    <% unless @data_widget_hash.keys.reverse[0..1].nil? %>
                      <% @data_widget_hash.keys.reverse[0..1].each do |k| %>
                        <% value = @data_widget_hash[k] %>
                        <% unless value.is_a?(Hash) %>
                          <div class="col">
                            <div class="card card-man-day">
                              <div class="card-body">
                                <span><%= k %></span>
                                <div class="quantity">
                                  <span>
                                    <%= value.nil? ? '-' : value %>
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>

                  <div class="row estimation-overview-infos mb-3">
                    <% unless @data_widget_hash.keys.reverse[1..3].nil? %>
                      <% @data_widget_hash.keys.reverse[1..3].each do |k| %>
                        <% value = @data_widget_hash[k] %>
                        <% unless value.is_a?(Hash) %>
                          <div class="col">
                            <%= k %>
                            <div class="estimation-overview-info-number">
                              <span>
                                <%= value %>
                              </span>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>

                  <div class="row estimation-overview-infos mb-3">
                    <% unless @data_widget_hash.keys.reverse[3..5].nil? %>
                      <% @data_widget_hash.keys.reverse[3..5].each do |k| %>
                        <% value = @data_widget_hash[k] %>
                        <% unless value.is_a?(Hash) %>
                          <div class="col">
                            <%= k %>
                            <div class="estimation-overview-info-number">
                              <span>
                                <%= value %>
                              </span>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>

                  <div class="row estimation-overview-infos mb-3">
                    <% unless @data_widget_hash.keys.reverse[5..7].nil? %>
                      <% @data_widget_hash.keys.reverse[5..7].each do |k| %>
                        <% value = @data_widget_hash[k] %>
                        <% unless value.is_a?(Hash) %>
                          <div class="col">
                            <%= k %>
                            <div class="estimation-overview-info-number">
                              <span>
                                <%= value %>
                              </span>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>

                </div>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>
    // Quand l'utilisateur scroll, on passe l'overview en sticky si besoin
    window.onscroll = function() {setOverviewSticky()};

    function setOverviewSticky(pOverview) {
        var overview;
        if (pOverview) {
            overview = pOverview;
        } else {
            overview = $(".estimation-overview:visible");
        }
        var table = $(".estimation-table");
        var tableTop = table[0].offsetTop + 58;
        var tableBottom = table[0].offsetTop + table[0].offsetHeight;

        if(overview.length) {
            if (window.pageYOffset > tableTop && (window.pageYOffset + window.innerHeight) < tableBottom) {
                overview.removeClass('sticky-bottom').addClass("sticky");
                overview.children('.card-body').css("width", ((table.width() * 55 / 100) - 42) + "px");
                overview.children('.card-body').css("min-height", "900px");
            } else if(window.pageYOffset > tableTop) {
                if((overview.children('.card-body')[0].offsetHeight > tableBottom - window.pageYOffset)) {
                    overview.addClass("sticky").addClass("sticky-bottom");
                } else {
                    overview.removeClass('sticky-bottom').addClass("sticky")
                }
                overview.children('.card-body').css("width", ((table.width() * 55 / 100) - 42) + "px");
                overview.children('.card-body').css("min-height", "900px");
            } else {
                overview.removeClass("sticky").removeClass("sticky-bottom");
                // overview.children('.card-body').removeAttr("style");
            }
        }
    }

</script>




